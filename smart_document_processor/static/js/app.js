/**
 * Smart Document Processor - Main Application JS
 * WPS Office Style Document Processing System
 */

// ÂÖ®Â±ÄÂ∫îÁî®Áä∂ÊÄÅ
const App = {
    state: {
        currentDocument: null,
        documentList: [],
        isProcessing: false,
        zoomLevel: 100,
        activeTab: 'files',
        connectionStatus: 'disconnected'
    },
    
    elements: {},
    
    init() {
        this.initElements();
        this.bindEvents();
        this.initWebSocket();
        this.loadDocumentList();
        this.updateClock();
        this.setupDragAndDrop();
        
        console.log('üì± Êô∫ËÉΩÊñáÊ°£Â§ÑÁêÜÁ≥ªÁªüÂ∑≤ÂêØÂä®');
    },
    
    initElements() {
        // ÁºìÂ≠òÂ∏∏Áî®ÂÖÉÁ¥†
        this.elements = {
            documentTitle: document.getElementById('documentTitle'),
            currentDocumentTitle: document.getElementById('currentDocumentTitle'),
            welcomeScreen: document.getElementById('welcomeScreen'),
            documentContent: document.getElementById('documentContent'),
            documentViewer: document.getElementById('documentViewer'),
            fileList: document.getElementById('fileList'),
            connectionStatus: document.getElementById('connectionStatus'),
            documentCount: document.getElementById('documentCount'),
            wordCount: document.getElementById('wordCount'),
            currentTime: document.getElementById('currentTime'),
            progressContainer: document.getElementById('progressContainer'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            zoomLevel: document.getElementById('zoomLevel'),
            notificationContainer: document.getElementById('notificationContainer'),
            
            // Â∑•ÂÖ∑Ê†èÊåâÈíÆ
            processBtn: document.getElementById('processBtn'),
            enhanceBtn: document.getElementById('enhanceBtn'),
            enhanceMenuBtn: document.getElementById('enhanceMenuBtn'),
            exportBtn: document.getElementById('exportBtn'),
            shareBtn: document.getElementById('shareBtn'),
            
            // Êñá‰ª∂ËæìÂÖ•
            fileInput: document.getElementById('fileInput'),
            hiddenFileInput: document.getElementById('hiddenFileInput'),
            
            // ‰∏ä‰º†Âå∫Âüü
            uploadArea: document.getElementById('uploadArea')
        };
    },
    
    bindEvents() {
        // Êñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
        if (this.elements.fileInput) {
            this.elements.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
        }
        
        if (this.elements.hiddenFileInput) {
            this.elements.hiddenFileInput.addEventListener('change', this.handleFileSelect.bind(this));
        }
        
        // ÁÇπÂáª‰∫ã‰ª∂ÂßîÊâò
        document.addEventListener('click', this.handleDocumentClick.bind(this));
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', this.handleKeyboardShortcuts.bind(this));
        
        // Á™óÂè£Â§ßÂ∞èÂèòÂåñ
        window.addEventListener('resize', this.handleWindowResize.bind(this));
        
        // È°µÈù¢Á¶ªÂºÄÂâçÁ°ÆËÆ§
        window.addEventListener('beforeunload', this.handleBeforeUnload.bind(this));
    },
    
    handleDocumentClick(event) {
        const target = event.target;
        
        // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        if (!target.closest('.dropdown') && !target.closest('.file-menu')) {
            this.closeAllDropdowns();
        }
        
        // Êñá‰ª∂È°πÁÇπÂáª
        if (target.closest('.file-item')) {
            const fileItem = target.closest('.file-item');
            const docId = fileItem.dataset.documentId;
            if (docId) {
                this.selectDocument(docId);
            }
        }
    },
    
    handleKeyboardShortcuts(event) {
        if (event.ctrlKey || event.metaKey) {
            switch (event.key) {
                case 'o':
                    event.preventDefault();
                    this.openFileDialog();
                    break;
                case 's':
                    event.preventDefault();
                    if (this.state.currentDocument) {
                        this.showExportOptions();
                    }
                    break;
                case 'n':
                    event.preventDefault();
                    this.newDocument();
                    break;
                case '=':
                case '+':
                    event.preventDefault();
                    this.zoomIn();
                    break;
                case '-':
                    event.preventDefault();
                    this.zoomOut();
                    break;
            }
        }
        
        // ESC ÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        if (event.key === 'Escape') {
            this.closeAllModals();
        }
    },
    
    handleWindowResize() {
        // ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄË∞ÉÊï¥
        this.adjustLayout();
    },
    
    handleBeforeUnload(event) {
        if (this.state.isProcessing) {
            const message = 'ÊñáÊ°£Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåÁ°ÆÂÆöË¶ÅÁ¶ªÂºÄÂêóÔºü';
            event.returnValue = message;
            return message;
        }
    },
    
    setupDragAndDrop() {
        const uploadArea = this.elements.uploadArea;
        if (!uploadArea) return;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, this.preventDefaults.bind(this), false);
            document.body.addEventListener(eventName, this.preventDefaults.bind(this), false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('dragover');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('dragover');
            }, false);
        });
        
        uploadArea.addEventListener('drop', this.handleDrop.bind(this), false);
    },
    
    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    },
    
    handleDrop(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            this.handleFiles(files);
            this.closeModal('uploadModal');
        }
    },
    
    async handleFileSelect(event) {
        const files = event.target.files;
        if (files.length > 0) {
            await this.handleFiles(files);
        }
    },
    
    async handleFiles(files) {
        for (let file of files) {
            if (this.validateFile(file)) {
                await this.uploadFile(file);
            }
        }
    },
    
    validateFile(file) {
        const maxSize = 50 * 1024 * 1024; // 50MB
        const allowedTypes = [
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/pdf',
            'text/plain',
            'text/html',
            'application/msword'
        ];
        
        if (file.size > maxSize) {
            this.showNotification('error', 'Êñá‰ª∂Â§™Â§ß', `Êñá‰ª∂ "${file.name}" Ë∂ÖËøá 50MB ÈôêÂà∂`);
            return false;
        }
        
        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(docx|pdf|txt|html|doc)$/i)) {
            this.showNotification('error', '‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè', `Êñá‰ª∂ "${file.name}" Ê†ºÂºè‰∏çÂèóÊîØÊåÅ`);
            return false;
        }
        
        return true;
    },
    
    async uploadFile(file) {
        try {
            this.showProgress(0, 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...');
            
            const formData = new FormData();
            formData.append('file', file);
            
            const xhr = new XMLHttpRequest();
            
            // ‰∏ä‰º†ËøõÂ∫¶
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    this.updateProgress(percentComplete, 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...');
                }
            });
            
            const response = await new Promise((resolve, reject) => {
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error(xhr.responseText));
                    }
                };
                xhr.onerror = () => reject(new Error('‰∏ä‰º†Â§±Ë¥•'));
                xhr.open('POST', '/api/upload');
                xhr.send(formData);
            });
            
            this.hideProgress();
            
            if (response.success) {
                this.showNotification('success', '‰∏ä‰º†ÊàêÂäü', `Êñá‰ª∂ "${response.filename}" ‰∏ä‰º†ÂÆåÊàê`);
                await this.loadDocumentList();
                this.selectDocument(response.document_id);
            } else {
                throw new Error(response.message || '‰∏ä‰º†Â§±Ë¥•');
            }
            
        } catch (error) {
            this.hideProgress();
            this.showNotification('error', '‰∏ä‰º†Â§±Ë¥•', error.message);
            console.error('File upload error:', error);
        }
    },
    
    async loadDocumentList() {
        try {
            const response = await fetch('/api/documents');
            const data = await response.json();
            
            if (data.success) {
                this.state.documentList = data.documents;
                this.renderDocumentList();
                this.updateDocumentCount();
            }
        } catch (error) {
            console.error('Failed to load document list:', error);
            this.showNotification('error', 'Âä†ËΩΩÂ§±Ë¥•', 'Êó†Ê≥ïËé∑ÂèñÊñáÊ°£ÂàóË°®');
        }
    },
    
    renderDocumentList() {
        const fileList = this.elements.fileList;
        if (!fileList) return;
        
        if (this.state.documentList.length === 0) {
            fileList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-upload"></i>
                    <p>ËøòÊ≤°ÊúâÊñáÊ°£</p>
                    <button class="upload-btn" onclick="openFileDialog()">‰∏ä‰º†ÊñáÊ°£</button>
                </div>
            `;
            return;
        }
        
        const fileItemsHTML = this.state.documentList.map(doc => {
            const isActive = this.state.currentDocument && this.state.currentDocument.document_id === doc.document_id;
            const statusClass = this.getStatusClass(doc.processing_stage);
            const statusText = this.getStatusText(doc.processing_stage);
            const fileIcon = this.getFileIcon(doc.filename);
            const fileSize = this.formatFileSize(doc.size);
            const uploadTime = this.formatTime(doc.upload_time);
            
            return `
                <div class="file-item ${isActive ? 'active' : ''}" data-document-id="${doc.document_id}">
                    <div class="file-info">
                        <i class="file-icon ${fileIcon}"></i>
                        <span class="file-name" title="${doc.filename}">${doc.filename}</span>
                    </div>
                    <div class="file-meta">
                        <span class="file-status ${statusClass}">${statusText}</span>
                        <span>${fileSize}</span>
                    </div>
                    <div class="file-meta">
                        <span>${uploadTime}</span>
                        <button class="icon-btn small" onclick="deleteDocument('${doc.document_id}')" title="Âà†Èô§">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        fileList.innerHTML = fileItemsHTML;
    },
    
    getStatusClass(stage) {
        const statusMap = {
            'uploaded': 'uploaded',
            'parsed': 'processing',
            'analyzed': 'processing',
            'ai_processed': 'processing',
            'processed': 'processed',
            'completed': 'processed'
        };
        return statusMap[stage] || 'uploaded';
    },
    
    getStatusText(stage) {
        const statusMap = {
            'uploaded': 'Â∑≤‰∏ä‰º†',
            'parsed': 'Ëß£Êûê‰∏≠',
            'analyzed': 'ÂàÜÊûê‰∏≠',
            'ai_processed': 'Â§ÑÁêÜ‰∏≠',
            'processed': 'Â∑≤Â§ÑÁêÜ',
            'completed': 'Â∑≤ÂÆåÊàê'
        };
        return statusMap[stage] || 'Êú™Áü•';
    },
    
    getFileIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'docx': 'fas fa-file-word',
            'doc': 'fas fa-file-word',
            'pdf': 'fas fa-file-pdf',
            'txt': 'fas fa-file-alt',
            'html': 'fas fa-file-code'
        };
        return iconMap[extension] || 'fas fa-file';
    },
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },
    
    formatTime(timeString) {
        const date = new Date(timeString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'ÂàöÂàö';
        if (diffMins < 60) return `${diffMins}ÂàÜÈíüÂâç`;
        if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
        if (diffDays < 7) return `${diffDays}Â§©Ââç`;
        
        return date.toLocaleDateString('zh-CN');
    },
    
    async selectDocument(documentId) {
        try {
            const response = await fetch(`/api/document/${documentId}`);
            const data = await response.json();
            
            if (data.success) {
                this.state.currentDocument = data;
                this.renderDocument();
                this.updateToolbarState();
                this.updateDocumentTitle(data.filename);
                
                // Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®ÈÄâ‰∏≠Áä∂ÊÄÅ
                this.renderDocumentList();
            } else {
                throw new Error(data.message || 'Ëé∑ÂèñÊñáÊ°£Â§±Ë¥•');
            }
        } catch (error) {
            console.error('Failed to select document:', error);
            this.showNotification('error', 'Âä†ËΩΩÂ§±Ë¥•', error.message);
        }
    },
    
    renderDocument() {
        if (!this.state.currentDocument) return;
        
        const doc = this.state.currentDocument;
        
        // ÈöêËóèÊ¨¢ËøéÈ°µÈù¢ÔºåÊòæÁ§∫ÊñáÊ°£ÂÜÖÂÆπ
        this.elements.welcomeScreen.style.display = 'none';
        this.elements.documentContent.style.display = 'block';
        
        // Êõ¥Êñ∞ÊñáÊ°£‰ø°ÊÅØ
        this.elements.currentDocumentTitle.textContent = doc.filename;
        document.getElementById('documentStatus').textContent = this.getStatusText(doc.processing_stage);
        document.getElementById('lastModified').textContent = 'ÂàöÂàö';
        document.getElementById('documentSize').textContent = this.formatFileSize(doc.metadata?.file_size || 0);
        
        // Ê∏≤ÊüìÊñáÊ°£ÂÜÖÂÆπ
        this.renderDocumentContent();
        
        // Êõ¥Êñ∞Â≠óÊï∞ÁªüËÆ°
        this.updateWordCount();
    },
    
    renderDocumentContent() {
        const doc = this.state.currentDocument;
        const viewer = this.elements.documentViewer;
        
        if (!doc.processed_content && !doc.analyzed_content) {
            viewer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-alt"></i>
                    <p>ÊñáÊ°£Â∞öÊú™Â§ÑÁêÜ</p>
                    <p class="small">ÁÇπÂáª "AIÂ§ÑÁêÜ" ÊåâÈíÆÂºÄÂßãÂ§ÑÁêÜÊñáÊ°£</p>
                </div>
            `;
            return;
        }
        
        const content = doc.processed_content || doc.analyzed_content;
        let html = '';
        
        // Ê∏≤ÊüìÊñáÊú¨ÂÖÉÁ¥†
        if (content.text_elements) {
            content.text_elements.forEach(elem => {
                const isModified = elem.modified ? 'modified' : '';
                html += `
                    <div class="document-element text-element ${isModified}" data-element-id="${elem.id}">
                        ${this.escapeHtml(elem.content)}
                    </div>
                `;
            });
        }
        
        // Ê∏≤ÊüìÂõæÂÉèÂÖÉÁ¥†
        if (content.image_elements) {
            content.image_elements.forEach(elem => {
                const imageDataUrl = `data:image/jpeg;base64,${this.arrayBufferToBase64(elem.data)}`;
                const caption = elem.analysis?.description || '';
                
                html += `
                    <div class="document-element image-element" data-element-id="${elem.id}">
                        <img src="${imageDataUrl}" alt="ÊñáÊ°£ÂõæÁâá" />
                        ${caption ? `<div class="image-caption">${this.escapeHtml(caption)}</div>` : ''}
                    </div>
                `;
            });
        }
        
        // Ê∏≤ÊüìË°®Ê†ºÂÖÉÁ¥†
        if (content.table_elements) {
            content.table_elements.forEach(elem => {
                if (elem.content && elem.content.length > 0) {
                    html += `
                        <div class="document-element table-element" data-element-id="${elem.id}">
                            <table class="document-table">
                    `;
                    
                    elem.content.forEach((row, rowIndex) => {
                        const isHeader = rowIndex === 0;
                        html += '<tr>';
                        row.forEach(cell => {
                            const tag = isHeader ? 'th' : 'td';
                            html += `<${tag}>${this.escapeHtml(cell)}</${tag}>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</table></div>';
                }
            });
        }
        
        if (!html) {
            html = `
                <div class="empty-state">
                    <i class="fas fa-file-alt"></i>
                    <p>ÊñáÊ°£ÂÜÖÂÆπ‰∏∫Á©∫</p>
                </div>
            `;
        }
        
        viewer.innerHTML = html;
    },
    
    updateToolbarState() {
        const hasDocument = !!this.state.currentDocument;
        const isProcessed = hasDocument && (this.state.currentDocument.processed_content || this.state.currentDocument.analyzed_content);
        
        // ÂêØÁî®/Á¶ÅÁî®ÊåâÈíÆ
        this.elements.processBtn.disabled = !hasDocument;
        this.elements.enhanceBtn.disabled = !hasDocument;
        this.elements.enhanceMenuBtn.disabled = !hasDocument;
        this.elements.exportBtn.disabled = !isProcessed;
        this.elements.shareBtn.disabled = !isProcessed;
    },
    
    updateDocumentTitle(filename) {
        if (filename) {
            this.elements.documentTitle.value = filename;
            document.title = `${filename} - Êô∫ËÉΩÊñáÊ°£Â§ÑÁêÜÁ≥ªÁªü`;
        } else {
            this.elements.documentTitle.value = 'Êú™ÂëΩÂêçÊñáÊ°£';
            document.title = 'Êô∫ËÉΩÊñáÊ°£Â§ÑÁêÜÁ≥ªÁªü';
        }
    },
    
    updateDocumentCount() {
        this.elements.documentCount.textContent = `${this.state.documentList.length} ‰∏™ÊñáÊ°£`;
    },
    
    updateWordCount() {
        let wordCount = 0;
        
        if (this.state.currentDocument?.processed_content?.text_elements) {
            this.state.currentDocument.processed_content.text_elements.forEach(elem => {
                wordCount += elem.content.length;
            });
        }
        
        this.elements.wordCount.textContent = `${wordCount} Â≠ó`;
    },
    
    updateClock() {
        const updateTime = () => {
            const now = new Date();
            this.elements.currentTime.textContent = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        };
        
        updateTime();
        setInterval(updateTime, 60000); // ÊØèÂàÜÈíüÊõ¥Êñ∞
    },
    
    adjustLayout() {
        // ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄË∞ÉÊï¥ÈÄªËæë
        const width = window.innerWidth;
        
        if (width < 768) {
            // ÁßªÂä®Á´ØÂ∏ÉÂ±ÄË∞ÉÊï¥
            document.body.classList.add('mobile-layout');
        } else {
            document.body.classList.remove('mobile-layout');
        }
    },
    
    showProgress(percent, text) {
        this.elements.progressContainer.style.display = 'flex';
        this.updateProgress(percent, text);
    },
    
    updateProgress(percent, text) {
        this.elements.progressFill.style.width = `${percent}%`;
        this.elements.progressText.textContent = text;
    },
    
    hideProgress() {
        this.elements.progressContainer.style.display = 'none';
    },
    
    showNotification(type, title, message, duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const iconMap = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="${iconMap[type]}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Ê∑ªÂä†ÂÖ≥Èó≠‰∫ã‰ª∂
        notification.querySelector('.notification-close').addEventListener('click', () => {
            this.removeNotification(notification);
        });
        
        // Ê∑ªÂä†Âà∞ÂÆπÂô®
        this.elements.notificationContainer.appendChild(notification);
        
        // ÊòæÁ§∫Âä®Áîª
        setTimeout(() => notification.classList.add('show'), 100);
        
        // Ëá™Âä®ÁßªÈô§
        if (duration > 0) {
            setTimeout(() => this.removeNotification(notification), duration);
        }
    },
    
    removeNotification(notification) {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    },
    
    closeAllDropdowns() {
        document.querySelectorAll('.dropdown-menu, .dropdown-content').forEach(menu => {
            menu.classList.remove('show');
        });
    },
    
    closeAllModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('show');
        });
    },
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },
    
    arrayBufferToBase64(buffer) {
        if (typeof buffer === 'string') return buffer;
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }
};

// ÂàùÂßãÂåñÂ∫îÁî®
document.addEventListener('DOMContentLoaded', () => {
    App.init();
});

// ÂÖ®Â±ÄÂáΩÊï∞Ôºà‰æõHTMLË∞ÉÁî®Ôºâ
window.App = App;

// ÂØºÂá∫Â∏∏Áî®ÂáΩÊï∞
window.openFileDialog = () => document.getElementById('hiddenFileInput').click();
window.newDocument = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'Êñ∞Âª∫ÊñáÊ°£ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');
window.openRecentFiles = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ÊúÄËøëÊñá‰ª∂ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');
window.showSettings = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ËÆæÁΩÆÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');
window.showHelp = () => App.showNotification('info', 'Â∏ÆÂä©', 'Êô∫ËÉΩÊñáÊ°£Â§ÑÁêÜÁ≥ªÁªü v1.0.0');
window.showUserMenu = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'Áî®Êà∑ËèúÂçïÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');

window.refreshFileList = () => App.loadDocumentList();
window.deleteDocument = async (docId) => {
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÊ°£ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
        try {
            const response = await fetch(`/api/document/${docId}`, { method: 'DELETE' });
            const data = await response.json();
            
            if (data.success) {
                App.showNotification('success', 'Âà†Èô§ÊàêÂäü', 'ÊñáÊ°£Â∑≤Âà†Èô§');
                App.loadDocumentList();
                
                // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÊñáÊ°£ÔºåÈáçÁΩÆÁïåÈù¢
                if (App.state.currentDocument?.document_id === docId) {
                    App.state.currentDocument = null;
                    App.elements.welcomeScreen.style.display = 'block';
                    App.elements.documentContent.style.display = 'none';
                    App.updateToolbarState();
                    App.updateDocumentTitle();
                }
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            App.showNotification('error', 'Âà†Èô§Â§±Ë¥•', error.message);
        }
    }
};

// Â∑•ÂÖ∑Ê†èÂäüËÉΩ
window.processDocument = () => {
    if (!App.state.currentDocument) {
        App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÊñáÊ°£', 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÊñáÊ°£ÂêéÂÜçËøõË°åAIÂ§ÑÁêÜ');
        return;
    }
    showModal('processModal');
};

window.enhanceDocument = async (type) => {
    if (!App.state.currentDocument) {
        App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÊñáÊ°£', 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÊñáÊ°£ÂêéÂÜçËøõË°åAIÂ¢ûÂº∫');
        return;
    }
    
    try {
        App.showProgress(0, 'AIÂ¢ûÂº∫Â§ÑÁêÜ‰∏≠...');
        
        const formData = new FormData();
        formData.append('doc_id', App.state.currentDocument.document_id);
        formData.append('enhancement_type', type);
        
        const response = await fetch('/api/ai/enhance', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            App.hideProgress();
            App.showNotification('success', 'AIÂ¢ûÂº∫ÂÆåÊàê', `ÊñáÊ°£Â∑≤‰ΩøÁî®${type}È£éÊ†ºËøõË°å‰ºòÂåñ`);
            
            // ÈáçÊñ∞Âä†ËΩΩÊñáÊ°£ÂÜÖÂÆπ
            App.selectDocument(App.state.currentDocument.document_id);
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        App.hideProgress();
        App.showNotification('error', 'AIÂ¢ûÂº∫Â§±Ë¥•', error.message);
    }
};

window.showExportOptions = () => {
    if (!App.state.currentDocument) {
        App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÊñáÊ°£', 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™Â∑≤Â§ÑÁêÜÁöÑÊñáÊ°£ÂêéÂÜçÂØºÂá∫');
        return;
    }
    showModal('exportModal');
};

window.shareDocument = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ÊñáÊ°£ÂàÜ‰∫´ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');

// Áº©ÊîæÊéßÂà∂
window.zoomIn = () => {
    App.state.zoomLevel = Math.min(App.state.zoomLevel + 10, 200);
    App.elements.zoomLevel.textContent = `${App.state.zoomLevel}%`;
    App.elements.documentViewer.style.zoom = App.state.zoomLevel / 100;
};

window.zoomOut = () => {
    App.state.zoomLevel = Math.max(App.state.zoomLevel - 10, 50);
    App.elements.zoomLevel.textContent = `${App.state.zoomLevel}%`;
    App.elements.documentViewer.style.zoom = App.state.zoomLevel / 100;
};

// Ê†áÁ≠æÈ°µÂàáÊç¢
window.switchTab = (tabName) => {
    // ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    App.state.activeTab = tabName;
};

// ‰∏ãÊãâËèúÂçïÊéßÂà∂
window.toggleFileMenu = () => {
    const menu = document.getElementById('fileMenu');
    menu.classList.toggle('show');
};

window.toggleEnhanceMenu = () => {
    const menu = document.getElementById('enhanceMenu');
    menu.classList.toggle('show');
};

// Ê®°ÊÄÅÊ°ÜÊéßÂà∂
window.showModal = (modalId) => {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
};

window.closeModal = (modalId) => {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
};

// Â±ûÊÄßÈù¢ÊùøÊéßÂà∂
window.togglePropertiesPanel = () => {
    const panel = document.getElementById('propertiesPanel');
    panel.classList.toggle('show');
};

// ÊñáÊ°£Êìç‰Ωú
window.editDocument = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ÊñáÊ°£ÁºñËæëÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');
window.previewDocument = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ÊñáÊ°£È¢ÑËßàÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');

console.log('üéØ Â∫îÁî®Ê†∏ÂøÉÊ®°ÂùóÂ∑≤Âä†ËΩΩ');