/**
 * Smart Document Processor - Main Application JS
 * WPS Office Style Document Processing System
 */

// ÂÖ®Â±ÄÂ∫îÁî®Áä∂ÊÄÅ
const App = {
    state: {
        currentDocument: null,
        documentList: [],
        isProcessing: false,
        zoomLevel: 100,
        activeTab: 'files',
        connectionStatus: 'disconnected'
    },
    
    elements: {},
    
    init() {
        this.initElements();
        this.bindEvents();
        this.initWebSocket();
        this.loadDocumentList();
        this.updateClock();
        this.setupDragAndDrop();
        
        console.log('üì± Êô∫ËÉΩÊñáÊ°£Â§ÑÁêÜÁ≥ªÁªüÂ∑≤ÂêØÂä®');
    },
    
    initElements() {
        // ÁºìÂ≠òÂ∏∏Áî®ÂÖÉÁ¥†
        this.elements = {
            documentTitle: document.getElementById('documentTitle'),
            currentDocumentTitle: document.getElementById('currentDocumentTitle'),
            welcomeScreen: document.getElementById('welcomeScreen'),
            documentContent: document.getElementById('documentContent'),
            documentViewer: document.getElementById('documentViewer'),
            fileList: document.getElementById('fileList'),
            connectionStatus: document.getElementById('connectionStatus'),
            documentCount: document.getElementById('documentCount'),
            wordCount: document.getElementById('wordCount'),
            currentTime: document.getElementById('currentTime'),
            progressContainer: document.getElementById('progressContainer'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            zoomLevel: document.getElementById('zoomLevel'),
            notificationContainer: document.getElementById('notificationContainer'),
            
            // Â∑•ÂÖ∑Ê†èÊåâÈíÆ
            processBtn: document.getElementById('processBtn'),
            enhanceBtn: document.getElementById('enhanceBtn'),
            enhanceMenuBtn: document.getElementById('enhanceMenuBtn'),
            exportBtn: document.getElementById('exportBtn'),
            shareBtn: document.getElementById('shareBtn'),
            
            // Êñá‰ª∂ËæìÂÖ•
            fileInput: document.getElementById('fileInput'),
            hiddenFileInput: document.getElementById('hiddenFileInput'),
            
            // ‰∏ä‰º†Âå∫Âüü
            uploadArea: document.getElementById('uploadArea')
        };
    },
    
    bindEvents() {
        // Êñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
        if (this.elements.fileInput) {
            this.elements.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
        }
        
        if (this.elements.hiddenFileInput) {
            this.elements.hiddenFileInput.addEventListener('change', this.handleFileSelect.bind(this));
        }
        
        // ÁÇπÂáª‰∫ã‰ª∂ÂßîÊâò
        document.addEventListener('click', this.handleDocumentClick.bind(this));
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', this.handleKeyboardShortcuts.bind(this));
        
        // Á™óÂè£Â§ßÂ∞èÂèòÂåñ
        window.addEventListener('resize', this.handleWindowResize.bind(this));
        
        // È°µÈù¢Á¶ªÂºÄÂâçÁ°ÆËÆ§
        window.addEventListener('beforeunload', this.handleBeforeUnload.bind(this));
    },
    
    handleDocumentClick(event) {
        const target = event.target;
        
        // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        if (!target.closest('.dropdown') && !target.closest('.file-menu')) {
            this.closeAllDropdowns();
        }
        
        // Êñá‰ª∂È°πÁÇπÂáª
        if (target.closest('.file-item')) {
            const fileItem = target.closest('.file-item');
            const docId = fileItem.dataset.documentId;
            if (docId) {
                this.selectDocument(docId);
            }
        }
    },
    
    handleKeyboardShortcuts(event) {
        if (event.ctrlKey || event.metaKey) {
            switch (event.key) {
                case 'o':
                    event.preventDefault();
                    this.openFileDialog();
                    break;
                case 's':
                    event.preventDefault();
                    if (this.state.currentDocument) {
                        this.showExportOptions();
                    }
                    break;
                case 'n':
                    event.preventDefault();
                    this.newDocument();
                    break;
                case '=':
                case '+':
                    event.preventDefault();
                    this.zoomIn();
                    break;
                case '-':
                    event.preventDefault();
                    this.zoomOut();
                    break;
            }
        }
        
        // ESC ÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        if (event.key === 'Escape') {
            this.closeAllModals();
        }
    },
    
    handleWindowResize() {
        // ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄË∞ÉÊï¥
        this.adjustLayout();
    },
    
    handleBeforeUnload(event) {
        if (this.state.isProcessing) {
            const message = 'ÊñáÊ°£Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåÁ°ÆÂÆöË¶ÅÁ¶ªÂºÄÂêóÔºü';
            event.returnValue = message;
            return message;
        }
    },
    
    setupDragAndDrop() {
        const uploadArea = this.elements.uploadArea;
        if (!uploadArea) return;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, this.preventDefaults.bind(this), false);
            document.body.addEventListener(eventName, this.preventDefaults.bind(this), false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('dragover');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('dragover');
            }, false);
        });
        
        uploadArea.addEventListener('drop', this.handleDrop.bind(this), false);
    },
    
    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    },
    
    handleDrop(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            this.handleFiles(files);
            this.closeModal('uploadModal');
        }
    },
    
    async handleFileSelect(event) {
        const files = event.target.files;
        if (files.length > 0) {
            await this.handleFiles(files);
        }
    },
    
    async handleFiles(files) {
        for (let file of files) {
            if (this.validateFile(file)) {
                await this.uploadFile(file);
            }
        }
    },
    
    validateFile(file) {
        const maxSize = 50 * 1024 * 1024; // 50MB
        const allowedTypes = [
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/pdf',
            'text/plain',
            'text/html',
            'application/msword'
        ];
        
        if (file.size > maxSize) {
            this.showNotification('error', 'Êñá‰ª∂Â§™Â§ß', `Êñá‰ª∂ "${file.name}" Ë∂ÖËøá 50MB ÈôêÂà∂`);
            return false;
        }
        
        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(docx|pdf|txt|html|doc)$/i)) {
            this.showNotification('error', '‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè', `Êñá‰ª∂ "${file.name}" Ê†ºÂºè‰∏çÂèóÊîØÊåÅ`);
            return false;
        }
        
        return true;
    },
    
    async uploadFile(file) {
        try {
            this.showProgress(0, 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...');
            
            const formData = new FormData();
            formData.append('file', file);
            
            const xhr = new XMLHttpRequest();
            
            // ‰∏ä‰º†ËøõÂ∫¶
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    this.updateProgress(percentComplete, 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...');
                }
            });
            
            const response = await new Promise((resolve, reject) => {
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error(xhr.responseText));
                    }
                };
                xhr.onerror = () => reject(new Error('‰∏ä‰º†Â§±Ë¥•'));
                xhr.open('POST', '/api/upload');
                xhr.send(formData);
            });
            
            this.hideProgress();
            
            if (response.success) {
                this.showNotification('success', '‰∏ä‰º†ÊàêÂäü', `Êñá‰ª∂ "${response.filename}" ‰∏ä‰º†ÂÆåÊàê`);
                await this.loadDocumentList();
                this.selectDocument(response.document_id);
            } else {
                throw new Error(response.message || '‰∏ä‰º†Â§±Ë¥•');
            }
            
        } catch (error) {
            this.hideProgress();
            this.showNotification('error', '‰∏ä‰º†Â§±Ë¥•', error.message);
            console.error('File upload error:', error);
        }
    },
    
    async loadDocumentList() {
        try {
            const response = await fetch('/api/documents');
            const data = await response.json();
            
            if (data.success) {
                this.state.documentList = data.documents;
                this.renderDocumentList();
                this.updateDocumentCount();
            }
        } catch (error) {
            console.error('Failed to load document list:', error);
            this.showNotification('error', 'Âä†ËΩΩÂ§±Ë¥•', 'Êó†Ê≥ïËé∑ÂèñÊñáÊ°£ÂàóË°®');
        }
    },
    
    renderDocumentList() {
        const fileList = this.elements.fileList;
        if (!fileList) return;
        
        if (this.state.documentList.length === 0) {
            fileList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-upload"></i>
                    <p>ËøòÊ≤°ÊúâÊñáÊ°£</p>
                    <button class="upload-btn" onclick="openFileDialog()">‰∏ä‰º†ÊñáÊ°£</button>
                </div>
            `;
            return;
        }
        
        const fileItemsHTML = this.state.documentList.map(doc => {
            const isActive = this.state.currentDocument && this.state.currentDocument.document_id === doc.document_id;
            const statusClass = this.getStatusClass(doc.processing_stage);
            const statusText = this.getStatusText(doc.processing_stage);
            const fileIcon = this.getFileIcon(doc.filename);
            const fileSize = this.formatFileSize(doc.size);
            const uploadTime = this.formatTime(doc.upload_time);
            
            return `
                <div class="file-item ${isActive ? 'active' : ''}" data-document-id="${doc.document_id}">
                    <div class="file-info">
                        <i class="file-icon ${fileIcon}"></i>
                        <span class="file-name" title="${doc.filename}">${doc.filename}</span>
                    </div>
                    <div class="file-meta">
                        <span class="file-status ${statusClass}">${statusText}</span>
                        <span>${fileSize}</span>
                    </div>
                    <div class="file-meta">
                        <span>${uploadTime}</span>
                        <button class="icon-btn small" onclick="deleteDocument('${doc.document_id}')" title="Âà†Èô§">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        fileList.innerHTML = fileItemsHTML;
    },
    
    getStatusClass(stage) {
        const statusMap = {
            'uploaded': 'uploaded',
            'parsed': 'processing',
            'analyzed': 'processing',
            'ai_processed': 'processing',
            'processed': 'processed',
            'completed': 'processed'
        };
        return statusMap[stage] || 'uploaded';
    },
    
    getStatusText(stage) {
        const statusMap = {
            'uploaded': 'Â∑≤‰∏ä‰º†',
            'parsed': 'Ëß£Êûê‰∏≠',
            'analyzed': 'ÂàÜÊûê‰∏≠',
            'ai_processed': 'Â§ÑÁêÜ‰∏≠',
            'processed': 'Â∑≤Â§ÑÁêÜ',
            'completed': 'Â∑≤ÂÆåÊàê'
        };
        return statusMap[stage] || 'Êú™Áü•';
    },
    
    getFileIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'docx': 'fas fa-file-word',
            'doc': 'fas fa-file-word',
            'pdf': 'fas fa-file-pdf',
            'txt': 'fas fa-file-alt',
            'html': 'fas fa-file-code'
        };
        return iconMap[extension] || 'fas fa-file';
    },
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },
    
    formatTime(timeString) {
        const date = new Date(timeString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'ÂàöÂàö';
        if (diffMins < 60) return `${diffMins}ÂàÜÈíüÂâç`;
        if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
        if (diffDays < 7) return `${diffDays}Â§©Ââç`;
        
        return date.toLocaleDateString('zh-CN');
    },
    
    async selectDocument(documentId) {
        try {
            const response = await fetch(`/api/document/${documentId}`);
            const data = await response.json();
            
            if (data.success) {
                this.state.currentDocument = data;
                this.renderDocument();
                this.updateToolbarState();
                this.updateDocumentTitle(data.filename);
                
                // Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®ÈÄâ‰∏≠Áä∂ÊÄÅ
                this.renderDocumentList();
            } else {
                throw new Error(data.message || 'Ëé∑ÂèñÊñáÊ°£Â§±Ë¥•');
            }
        } catch (error) {
            console.error('Failed to select document:', error);
            this.showNotification('error', 'Âä†ËΩΩÂ§±Ë¥•', error.message);
        }
    },
    
    renderDocument() {
        if (!this.state.currentDocument) return;
        
        const doc = this.state.currentDocument;
        
        // ÈöêËóèÊ¨¢ËøéÈ°µÈù¢ÔºåÊòæÁ§∫ÊñáÊ°£ÂÜÖÂÆπ
        this.elements.welcomeScreen.style.display = 'none';
        this.elements.documentContent.style.display = 'block';
        
        // Êõ¥Êñ∞ÊñáÊ°£‰ø°ÊÅØ
        this.elements.currentDocumentTitle.textContent = doc.filename;
        document.getElementById('documentStatus').textContent = this.getStatusText(doc.processing_stage);
        document.getElementById('lastModified').textContent = 'ÂàöÂàö';
        document.getElementById('documentSize').textContent = this.formatFileSize(doc.metadata?.file_size || 0);
        
        // Ê∏≤ÊüìÊñáÊ°£ÂÜÖÂÆπ
        this.renderDocumentContent();
        
        // Êõ¥Êñ∞Â≠óÊï∞ÁªüËÆ°
        this.updateWordCount();
    },
    
    renderDocumentContent() {
        const doc = this.state.currentDocument;
        const viewer = this.elements.documentViewer;
        
        if (!doc.processed_content && !doc.analyzed_content) {
            viewer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-alt"></i>
                    <p>ÊñáÊ°£Â∞öÊú™Â§ÑÁêÜ</p>
                    <p class="small">ÁÇπÂáª "AIÂ§ÑÁêÜ" ÊåâÈíÆÂºÄÂßãÂ§ÑÁêÜÊñáÊ°£</p>
                </div>
            `;
            return;
        }
        
        const content = doc.processed_content || doc.analyzed_content;
        let html = '';
        
        // Ê∏≤ÊüìÊñáÊú¨ÂÖÉÁ¥†
        if (content.text_elements) {
            content.text_elements.forEach(elem => {
                const isModified = elem.modified ? 'modified' : '';
                html += `
                    <div class="document-element text-element ${isModified}" data-element-id="${elem.id}">
                        ${this.escapeHtml(elem.content)}
                    </div>
                `;
            });
        }
        
        // Ê∏≤ÊüìÂõæÂÉèÂÖÉÁ¥†
        if (content.image_elements) {
            content.image_elements.forEach(elem => {
                const imageDataUrl = `data:image/jpeg;base64,${this.arrayBufferToBase64(elem.data)}`;
                const caption = elem.analysis?.description || '';
                
                html += `
                    <div class="document-element image-element" data-element-id="${elem.id}">
                        <img src="${imageDataUrl}" alt="ÊñáÊ°£ÂõæÁâá" />
                        ${caption ? `<div class="image-caption">${this.escapeHtml(caption)}</div>` : ''}
                    </div>
                `;
            });
        }
        
        // Ê∏≤ÊüìË°®Ê†ºÂÖÉÁ¥†
        if (content.table_elements) {
            content.table_elements.forEach(elem => {
                if (elem.content && elem.content.length > 0) {
                    html += `
                        <div class="document-element table-element" data-element-id="${elem.id}">
                            <table class="document-table">
                    `;
                    
                    elem.content.forEach((row, rowIndex) => {
                        const isHeader = rowIndex === 0;
                        html += '<tr>';
                        row.forEach(cell => {
                            const tag = isHeader ? 'th' : 'td';
                            html += `<${tag}>${this.escapeHtml(cell)}</${tag}>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</table></div>';
                }
            });
        }
        
        if (!html) {
            html = `
                <div class="empty-state">
                    <i class="fas fa-file-alt"></i>
                    <p>ÊñáÊ°£ÂÜÖÂÆπ‰∏∫Á©∫</p>
                </div>
            `;
        }
        
        viewer.innerHTML = html;
    },
    
    updateToolbarState() {
        const hasDocument = !!this.state.currentDocument;
        const isProcessed = hasDocument && (this.state.currentDocument.processed_content || this.state.currentDocument.analyzed_content);
        
        // ÂêØÁî®/Á¶ÅÁî®ÊåâÈíÆ
        this.elements.processBtn.disabled = !hasDocument;
        this.elements.enhanceBtn.disabled = !hasDocument;
        this.elements.enhanceMenuBtn.disabled = !hasDocument;
        this.elements.exportBtn.disabled = !isProcessed;
        this.elements.shareBtn.disabled = !isProcessed;
    },
    
    updateDocumentTitle(filename) {
        if (filename) {
            this.elements.documentTitle.value = filename;
            document.title = `${filename} - Êô∫ËÉΩÊñáÊ°£Â§ÑÁêÜÁ≥ªÁªü`;
        } else {
            this.elements.documentTitle.value = 'Êú™ÂëΩÂêçÊñáÊ°£';
            document.title = 'Êô∫ËÉΩÊñáÊ°£Â§ÑÁêÜÁ≥ªÁªü';
        }
    },
    
    updateDocumentCount() {
        this.elements.documentCount.textContent = `${this.state.documentList.length} ‰∏™ÊñáÊ°£`;
    },
    
    updateWordCount() {
        let wordCount = 0;
        
        if (this.state.currentDocument?.processed_content?.text_elements) {
            this.state.currentDocument.processed_content.text_elements.forEach(elem => {
                wordCount += elem.content.length;
            });
        }
        
        this.elements.wordCount.textContent = `${wordCount} Â≠ó`;
    },
    
    updateClock() {
        const updateTime = () => {
            const now = new Date();
            this.elements.currentTime.textContent = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        };
        
        updateTime();
        setInterval(updateTime, 60000); // ÊØèÂàÜÈíüÊõ¥Êñ∞
    },
    
    adjustLayout() {
        // ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄË∞ÉÊï¥ÈÄªËæë
        const width = window.innerWidth;
        
        if (width < 768) {
            // ÁßªÂä®Á´ØÂ∏ÉÂ±ÄË∞ÉÊï¥
            document.body.classList.add('mobile-layout');
        } else {
            document.body.classList.remove('mobile-layout');
        }
    },
    
    showProgress(percent, text) {
        this.elements.progressContainer.style.display = 'flex';
        this.updateProgress(percent, text);
    },
    
    updateProgress(percent, text) {
        this.elements.progressFill.style.width = `${percent}%`;
        this.elements.progressText.textContent = text;
    },
    
    hideProgress() {
        this.elements.progressContainer.style.display = 'none';
    },
    
    showNotification(type, title, message, duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const iconMap = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="${iconMap[type]}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Ê∑ªÂä†ÂÖ≥Èó≠‰∫ã‰ª∂
        notification.querySelector('.notification-close').addEventListener('click', () => {
            this.removeNotification(notification);
        });
        
        // Ê∑ªÂä†Âà∞ÂÆπÂô®
        this.elements.notificationContainer.appendChild(notification);
        
        // ÊòæÁ§∫Âä®Áîª
        setTimeout(() => notification.classList.add('show'), 100);
        
        // Ëá™Âä®ÁßªÈô§
        if (duration > 0) {
            setTimeout(() => this.removeNotification(notification), duration);
        }
    },
    
    removeNotification(notification) {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    },
    
    closeAllDropdowns() {
        document.querySelectorAll('.dropdown-menu, .dropdown-content').forEach(menu => {
            menu.classList.remove('show');
        });
    },
    
    closeAllModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('show');
        });
    },
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },
    
    arrayBufferToBase64(buffer) {
        if (typeof buffer === 'string') return buffer;
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }
};

// AI‰∫§‰∫íÂäüËÉΩ
const AIAssistant = {
    settings: {
        model: 'gpt-4',
        apiKey: '',
        maxTokens: 4000,
        temperature: 0.7,
        responseStyle: 'professional',
        language: 'zh-CN',
        systemPrompt: '‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÊñáÊ°£ÁºñËæëÂä©ÊâãÔºå‰∏ìÊ≥®‰∫éÂ∏ÆÂä©Áî®Êà∑ÊîπËøõÊñáÊ°£ÂÜÖÂÆπ„ÄÇËØ∑‰øùÊåÅ‰∏ì‰∏ö„ÄÅÂáÜÁ°ÆÂíåÊúâÂ∏ÆÂä©ÁöÑÊÄÅÂ∫¶„ÄÇ',
        autoSuggest: true,
        contextAware: true
    },
    
    chatHistory: [],
    selectedContent: null,
    isProcessing: false,
    
    init() {
        this.loadSettings();
        this.bindEvents();
        this.updateModelStatus();
        this.initSelectionDetection();
    },
    
    bindEvents() {
        // ÁõëÂê¨ÊñáÊ°£ÈÄâÊã©ÂèòÂåñ
        document.addEventListener('selectionchange', this.handleSelectionChange.bind(this));
        
        // ÂõûËΩ¶ÈîÆÂèëÈÄÅÊ∂àÊÅØ
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
        }
    },
    
    loadSettings() {
        const saved = localStorage.getItem('ai_settings');
        if (saved) {
            this.settings = { ...this.settings, ...JSON.parse(saved) };
        }
        this.applySettings();
    },
    
    saveSettings() {
        localStorage.setItem('ai_settings', JSON.stringify(this.settings));
    },
    
    applySettings() {
        // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
        document.getElementById('currentModel').textContent = this.settings.model.toUpperCase();
        document.getElementById('tokenCount').textContent = `${this.getTokenUsage()} tokens`;
        document.getElementById('monthlyQuota').textContent = `${this.getMonthlyQuota()} tokens`;
    },
    
    updateModelStatus() {
        const statusElement = document.getElementById('modelStatus');
        const isOnline = this.checkAPIConnection();
        
        if (isOnline) {
            statusElement.className = 'model-status online';
            statusElement.innerHTML = '<i class="fas fa-circle"></i> Âú®Á∫ø';
        } else {
            statusElement.className = 'model-status offline';
            statusElement.innerHTML = '<i class="fas fa-circle"></i> Á¶ªÁ∫ø';
        }
    },
    
    checkAPIConnection() {
        return this.settings.apiKey && this.settings.apiKey.length > 0;
    },
    
    getTokenUsage() {
        // Ê®°ÊãüÊï∞ÊçÆÔºåÂÆûÈôÖÂ∫î‰ªéÊúçÂä°Âô®Ëé∑Âèñ
        return 1250;
    },
    
    getMonthlyQuota() {
        // Ê®°ÊãüÊï∞ÊçÆÔºåÂÆûÈôÖÂ∫î‰ªéÊúçÂä°Âô®Ëé∑Âèñ
        return 48750;
    },
    
    initSelectionDetection() {
        // ÁõëÂê¨ÊñáÊ°£Âå∫ÂüüÁöÑÊñáÊú¨ÈÄâÊã©
        const documentViewer = document.getElementById('documentViewer');
        if (documentViewer) {
            documentViewer.addEventListener('mouseup', this.handleSelectionChange.bind(this));
        }
    },
    
    handleSelectionChange() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        
        if (selectedText && selectedText.length > 0) {
            this.selectedContent = {
                text: selectedText,
                range: selection.getRangeAt(0),
                element: selection.anchorNode.parentElement
            };
            this.showSelectedContent(selectedText);
        } else {
            this.selectedContent = null;
            this.hideSelectedContent();
        }
    },
    
    showSelectedContent(text) {
        const selectedContentDiv = document.getElementById('selectedContent');
        const selectedTextDiv = document.getElementById('selectedText');
        const selectedWordCount = document.getElementById('selectedWordCount');
        const selectedCharCount = document.getElementById('selectedCharCount');
        
        if (selectedContentDiv && selectedTextDiv) {
            selectedTextDiv.textContent = text.length > 100 ? text.substring(0, 100) + '...' : text;
            selectedWordCount.textContent = `${this.countWords(text)} Â≠ó`;
            selectedCharCount.textContent = `${text.length} Â≠óÁ¨¶`;
            selectedContentDiv.style.display = 'block';
        }
    },
    
    hideSelectedContent() {
        const selectedContentDiv = document.getElementById('selectedContent');
        if (selectedContentDiv) {
            selectedContentDiv.style.display = 'none';
        }
    },
    
    countWords(text) {
        // ‰∏≠Ëã±ÊñáÂ≠óÁ¨¶ÁªüËÆ°
        const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
        const englishWords = text.match(/[a-zA-Z]+/g) || [];
        return chineseChars.length + englishWords.length;
    },
    
    async sendMessage() {
        const chatInput = document.getElementById('chatInput');
        const message = chatInput.value.trim();
        
        if (!message) return;
        
        // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ËÅäÂ§©ÂéÜÂè≤
        this.addMessage('user', message);
        chatInput.value = '';
        
        // ÊòæÁ§∫Â§ÑÁêÜÁä∂ÊÄÅ
        this.showProcessing('Ê≠£Âú®ÊÄùËÄÉ‰∏≠...');
        
        try {
            // ÊûÑÂª∫ËØ∑Ê±ÇÊï∞ÊçÆ
            const requestData = {
                message: message,
                context: this.buildContext(),
                selected_text: this.selectedContent?.text || null,
                settings: this.settings
            };
            
            const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.addMessage('ai', data.response);
                
                // Â¶ÇÊûúÊúâÂª∫ËÆÆÁöÑÊìç‰ΩúÔºåÊòæÁ§∫Âª∫ËÆÆ
                if (data.suggestions) {
                    this.showSuggestions(data.suggestions);
                }
                
                // Â¶ÇÊûúÊúâÂÜÖÂÆπ‰øÆÊîπÔºåÂ∫îÁî®‰øÆÊîπ
                if (data.modifications) {
                    this.applyModifications(data.modifications);
                }
            } else {
                throw new Error(data.message || 'AIÂ§ÑÁêÜÂ§±Ë¥•');
            }
        } catch (error) {
            console.error('AI Chat Error:', error);
            this.addMessage('ai', 'Êä±Ê≠âÔºåÂ§ÑÁêÜÊÇ®ÁöÑËØ∑Ê±ÇÊó∂Âá∫Áé∞‰∫ÜÈîôËØØ„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
            App.showNotification('error', 'AIÈîôËØØ', error.message);
        } finally {
            this.hideProcessing();
        }
    },
    
    buildContext() {
        // ÊûÑÂª∫AIÈúÄË¶ÅÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ
        const context = {
            document: App.state.currentDocument ? {
                filename: App.state.currentDocument.filename,
                type: App.state.currentDocument.document_type
            } : null,
            chat_history: this.chatHistory.slice(-5), // ÊúÄËøë5Êù°Ê∂àÊÅØ
            timestamp: new Date().toISOString()
        };
        
        return context;
    },
    
    addMessage(sender, content) {
        const chatMessages = document.getElementById('chatMessages');
        const messageId = `msg_${Date.now()}`;
        const timestamp = new Date().toLocaleTimeString('zh-CN', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const messageHtml = `
            <div class="message ${sender}-message" id="${messageId}">
                <div class="message-avatar">
                    <i class="fas fa-${sender === 'ai' ? 'robot' : 'user'}"></i>
                </div>
                <div class="message-content">
                    <div class="message-text">${this.formatMessageContent(content)}</div>
                    <div class="message-time">${timestamp}</div>
                    ${sender === 'ai' ? this.getMessageActions() : ''}
                </div>
            </div>
        `;
        
        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Ê∑ªÂä†Âà∞ËÅäÂ§©ÂéÜÂè≤
        this.chatHistory.push({
            sender: sender,
            content: content,
            timestamp: new Date().toISOString()
        });
        
        // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÈïøÂ∫¶
        if (this.chatHistory.length > 50) {
            this.chatHistory = this.chatHistory.slice(-30);
        }
    },
    
    formatMessageContent(content) {
        // Ê†ºÂºèÂåñÊ∂àÊÅØÂÜÖÂÆπÔºåÊîØÊåÅÁÆÄÂçïÁöÑmarkdown
        return content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');
    },
    
    getMessageActions() {
        return `
            <div class="message-actions">
                <button class="action-link" onclick="AIAssistant.copyMessage(this)">Â§çÂà∂</button>
                <button class="action-link" onclick="AIAssistant.regenerateResponse(this)">ÈáçÊñ∞ÁîüÊàê</button>
            </div>
        `;
    },
    
    showProcessing(message) {
        const progressDiv = document.getElementById('aiProgress');
        const progressText = document.getElementById('progressText');
        const progressTitle = document.getElementById('progressTitle');
        
        if (progressDiv && progressText && progressTitle) {
            progressTitle.textContent = message;
            progressText.textContent = 'Ê≠£Âú®Â§ÑÁêÜÊÇ®ÁöÑËØ∑Ê±Ç...';
            progressDiv.style.display = 'block';
            this.isProcessing = true;
            
            // Ê®°ÊãüËøõÂ∫¶Êõ¥Êñ∞
            this.updateProcessingProgress();
        }
    },
    
    updateProcessingProgress() {
        const progressFill = document.querySelector('#aiProgress .progress-fill');
        let progress = 0;
        const interval = setInterval(() => {
            if (!this.isProcessing) {
                clearInterval(interval);
                return;
            }
            
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
        }, 200);
    },
    
    hideProcessing() {
        const progressDiv = document.getElementById('aiProgress');
        if (progressDiv) {
            progressDiv.style.display = 'none';
            this.isProcessing = false;
        }
    },
    
    showSuggestions(suggestions) {
        const suggestionsDiv = document.getElementById('aiSuggestions');
        const suggestionsList = document.getElementById('suggestionsList');
        
        if (suggestionsDiv && suggestionsList) {
            const suggestionsHtml = suggestions.map(suggestion => `
                <div class="suggestion-item" onclick="AIAssistant.applySuggestion('${suggestion.action}', '${suggestion.target}')">
                    ${suggestion.text}
                </div>
            `).join('');
            
            suggestionsList.innerHTML = suggestionsHtml;
            suggestionsDiv.style.display = 'block';
        }
    },
    
    async quickAction(action) {
        if (!this.selectedContent && !App.state.currentDocument) {
            App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÂÜÖÂÆπ', 'ËØ∑ÈÄâÊã©ÊñáÊ°£‰∏≠ÁöÑÂÜÖÂÆπÊàñÁ°Æ‰øùÊúâÊñáÊ°£ÊâìÂºÄ');
            return;
        }
        
        const actionMap = {
            'optimize': '‰ºòÂåñËøôÊÆµÊñáÂ≠óÁöÑË°®ËææÔºå‰ΩøÂÖ∂Êõ¥Ê∏ÖÊô∞ÊµÅÁïÖ',
            'summarize': '‰∏∫ËøôÊÆµÂÜÖÂÆπÁîüÊàêÁÆÄÊ¥ÅÁöÑÊëòË¶Å',
            'translate': 'Â∞ÜËøôÊÆµÂÜÖÂÆπÁøªËØë‰∏∫Ëã±Êñá',
            'rewrite': 'Áî®‰∏çÂêåÁöÑÊñπÂºèÈáçÂÜôËøôÊÆµÂÜÖÂÆπ',
            'expand': 'Êâ©Â±ïËøôÊÆµÂÜÖÂÆπÔºåÊ∑ªÂä†Êõ¥Â§öÁªÜËäÇ',
            'format': 'ÊîπÂñÑËøôÊÆµÂÜÖÂÆπÁöÑÊ†ºÂºèÂíåÁªìÊûÑ'
        };
        
        const instruction = actionMap[action];
        if (instruction) {
            document.getElementById('chatInput').value = instruction;
            await this.sendMessage();
        }
    },
    
    applyModifications(modifications) {
        // Â∫îÁî®AIÂª∫ËÆÆÁöÑ‰øÆÊîπÂà∞ÊñáÊ°£
        console.log('Applying modifications:', modifications);
        // ÂÆûÈôÖÂÆûÁé∞‰ºöÊõ¥Â§çÊùÇÔºåÈúÄË¶ÅÊõ¥Êñ∞ÊñáÊ°£ÂÜÖÂÆπ
    },
    
    applySuggestion(action, target) {
        console.log('Applying suggestion:', action, target);
        // ÂÆûÁé∞Âª∫ËÆÆÁöÑÂ∫îÁî®ÈÄªËæë
    },
    
    copyMessage(button) {
        const messageText = button.closest('.message').querySelector('.message-text').textContent;
        navigator.clipboard.writeText(messageText).then(() => {
            App.showNotification('success', 'Â∑≤Â§çÂà∂', 'Ê∂àÊÅØÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
        });
    },
    
    regenerateResponse(button) {
        // ÈáçÊñ∞ÁîüÊàêÊúÄÂêé‰∏Ä‰∏™AIÂìçÂ∫î
        const lastUserMessage = this.chatHistory.slice().reverse().find(msg => msg.sender === 'user');
        if (lastUserMessage) {
            document.getElementById('chatInput').value = lastUserMessage.content;
            this.sendMessage();
        }
    }
};

// AIËÆæÁΩÆÁõ∏ÂÖ≥ÂáΩÊï∞
function openAISettings() {
    document.getElementById('aiSettingsModal').classList.add('show');
    loadAISettingsValues();
}

function loadAISettingsValues() {
    // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆÂà∞Ë°®Âçï
    document.getElementById('aiModel').value = AIAssistant.settings.model;
    document.getElementById('apiKey').value = AIAssistant.settings.apiKey;
    document.getElementById('maxTokens').value = AIAssistant.settings.maxTokens;
    document.getElementById('temperature').value = AIAssistant.settings.temperature;
    document.getElementById('responseStyle').value = AIAssistant.settings.responseStyle;
    document.getElementById('language').value = AIAssistant.settings.language;
    document.getElementById('systemPrompt').value = AIAssistant.settings.systemPrompt;
    document.getElementById('autoSuggest').checked = AIAssistant.settings.autoSuggest;
    document.getElementById('contextAware').checked = AIAssistant.settings.contextAware;
    
    updateTokenDisplay(AIAssistant.settings.maxTokens);
    updateTemperatureDisplay(AIAssistant.settings.temperature);
}

function switchSettingsTab(tabName) {
    // ÂàáÊç¢ËÆæÁΩÆÊ†áÁ≠æÈ°µ
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.settings-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-settings`).classList.add('active');
}

function updateTokenDisplay(value) {
    document.getElementById('tokenDisplay').textContent = value;
}

function updateTemperatureDisplay(value) {
    const labels = ['‰øùÂÆà', 'Âπ≥Ë°°', 'ÂàõÈÄ†'];
    const index = Math.round(value * 1.5);
    document.getElementById('temperatureDisplay').textContent = labels[Math.min(index, 2)];
}

function updateModelSettings() {
    const model = document.getElementById('aiModel').value;
    // Ê†πÊçÆÊ®°ÂûãË∞ÉÊï¥ÈªòËÆ§ËÆæÁΩÆ
    const modelDefaults = {
        'gpt-4': { maxTokens: 4000, temperature: 0.7 },
        'gpt-4-turbo': { maxTokens: 8000, temperature: 0.7 },
        'gpt-3.5-turbo': { maxTokens: 3000, temperature: 0.8 },
        'claude-3': { maxTokens: 4000, temperature: 0.6 }
    };
    
    const defaults = modelDefaults[model];
    if (defaults) {
        document.getElementById('maxTokens').value = defaults.maxTokens;
        document.getElementById('temperature').value = defaults.temperature;
        updateTokenDisplay(defaults.maxTokens);
        updateTemperatureDisplay(defaults.temperature);
    }
}

function testAPIKey() {
    const apiKey = document.getElementById('apiKey').value;
    if (!apiKey) {
        App.showNotification('warning', 'ËØ∑ËæìÂÖ•APIÂØÜÈí•', 'ÈúÄË¶ÅAPIÂØÜÈí•ÊâçËÉΩÊµãËØïËøûÊé•');
        return;
    }
    
    // Ê®°ÊãüAPIÊµãËØï
    App.showNotification('info', 'ÊµãËØï‰∏≠', 'Ê≠£Âú®ÊµãËØïAPIËøûÊé•...');
    setTimeout(() => {
        App.showNotification('success', 'ËøûÊé•ÊàêÂäü', 'APIÂØÜÈí•ÊúâÊïàÔºåËøûÊé•Ê≠£Â∏∏');
    }, 2000);
}

function saveAISettings() {
    // ‰øùÂ≠òËÆæÁΩÆ
    AIAssistant.settings = {
        ...AIAssistant.settings,
        model: document.getElementById('aiModel').value,
        apiKey: document.getElementById('apiKey').value,
        maxTokens: parseInt(document.getElementById('maxTokens').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        responseStyle: document.getElementById('responseStyle').value,
        language: document.getElementById('language').value,
        systemPrompt: document.getElementById('systemPrompt').value,
        autoSuggest: document.getElementById('autoSuggest').checked,
        contextAware: document.getElementById('contextAware').checked
    };
    
    AIAssistant.saveSettings();
    AIAssistant.applySettings();
    AIAssistant.updateModelStatus();
    
    closeModal('aiSettingsModal');
    App.showNotification('success', 'ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'AIÂä©ÊâãËÆæÁΩÆÂ∑≤Êõ¥Êñ∞');
}

function resetSettings() {
    if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâËÆæÁΩÆÂêóÔºüËøôÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâËá™ÂÆö‰πâÈÖçÁΩÆ„ÄÇ')) {
        AIAssistant.settings = {
            model: 'gpt-4',
            apiKey: '',
            maxTokens: 4000,
            temperature: 0.7,
            responseStyle: 'professional',
            language: 'zh-CN',
            systemPrompt: '‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÊñáÊ°£ÁºñËæëÂä©ÊâãÔºå‰∏ìÊ≥®‰∫éÂ∏ÆÂä©Áî®Êà∑ÊîπËøõÊñáÊ°£ÂÜÖÂÆπ„ÄÇËØ∑‰øùÊåÅ‰∏ì‰∏ö„ÄÅÂáÜÁ°ÆÂíåÊúâÂ∏ÆÂä©ÁöÑÊÄÅÂ∫¶„ÄÇ',
            autoSuggest: true,
            contextAware: true
        };
        loadAISettingsValues();
        App.showNotification('info', 'ËÆæÁΩÆÂ∑≤ÈáçÁΩÆ', 'ÊâÄÊúâËÆæÁΩÆÂ∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÂÄº');
    }
}

function exportSettings() {
    const settings = JSON.stringify(AIAssistant.settings, null, 2);
    const blob = new Blob([settings], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ai_settings.json';
    a.click();
    URL.revokeObjectURL(url);
}

function importSettings() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const settings = JSON.parse(e.target.result);
                    AIAssistant.settings = { ...AIAssistant.settings, ...settings };
                    loadAISettingsValues();
                    App.showNotification('success', 'ËÆæÁΩÆÂ∑≤ÂØºÂÖ•', 'ÈÖçÁΩÆÊñá‰ª∂Â∑≤ÊàêÂäüÂä†ËΩΩ');
                } catch (error) {
                    App.showNotification('error', 'ÂØºÂÖ•Â§±Ë¥•', 'ÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ');
                }
            };
            reader.readAsText(file);
        }
    };
    input.click();
}

// Ê®°ÊùøÁõ∏ÂÖ≥ÂáΩÊï∞
function insertTemplate() {
    document.getElementById('templateModal').classList.add('show');
}

function insertInstructionTemplate(templateId) {
    const templates = {
        'optimize_clarity': 'ËØ∑‰ºòÂåñËøôÊÆµÊñáÂ≠óÁöÑÊ∏ÖÊô∞Â∫¶Ôºå‰ΩøË°®ËææÊõ¥ÂáÜÁ°ÆÊòìÊáÇÔºö',
        'optimize_tone': 'ËØ∑Ë∞ÉÊï¥ËøôÊÆµÊñáÂ≠óÁöÑËØ≠Ë∞ÉÔºå‰ΩøÂÖ∂Êõ¥ÈÄÇÂêàÁõÆÊ†áËØªËÄÖÔºö',
        'fix_grammar': 'ËØ∑Ê£ÄÊü•Âπ∂‰øÆÊ≠£ËøôÊÆµÊñáÂ≠óÁöÑËØ≠Ê≥ïÂíåÊãºÂÜôÈîôËØØÔºö',
        'summarize': 'ËØ∑‰∏∫ËøôÊÆµÂÜÖÂÆπÁîüÊàê‰∏Ä‰∏™ÁÆÄÊ¥ÅÊòé‰∫ÜÁöÑÊëòË¶ÅÔºö',
        'expand': 'ËØ∑Êâ©Â±ïËøôÊÆµÂÜÖÂÆπÔºåÊ∑ªÂä†Êõ¥Â§öÁõ∏ÂÖ≥ÁªÜËäÇÂíåËß£ÈáäÔºö',
        'restructure': 'ËØ∑ÈáçÊñ∞ÁªÑÁªáËøôÊÆµÂÜÖÂÆπÁöÑÁªìÊûÑÔºå‰ΩøÈÄªËæëÊõ¥Ê∏ÖÊô∞Ôºö',
        'translate_en': 'ËØ∑Â∞ÜËøôÊÆµÂÜÖÂÆπÁøªËØë‰∏∫Ëã±ÊñáÔºå‰øùÊåÅÂéüÊÑè‰∏çÂèòÔºö',
        'localize': 'ËØ∑Â∞ÜËøôÊÆµÂÜÖÂÆπÊú¨Âú∞ÂåñÔºå‰ΩøÂÖ∂Êõ¥ÈÄÇÂêà‰∏≠ÊñáËØªËÄÖÁöÑ‰π†ÊÉØÔºö'
    };
    
    const template = templates[templateId];
    if (template) {
        document.getElementById('chatInput').value = template;
        closeModal('templateModal');
        document.getElementById('chatInput').focus();
    }
}

// ÂÖ∂‰ªñAI‰∫§‰∫íÂáΩÊï∞
function toggleAIPanel() {
    const panel = document.getElementById('aiInteractionPanel');
    panel.classList.toggle('collapsed');
}

function clearSelection() {
    window.getSelection().removeAllRanges();
    AIAssistant.hideSelectedContent();
}

function clearChat() {
    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÂØπËØùËÆ∞ÂΩïÂêóÔºü')) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
            <div class="message ai-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-text">
                        ‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑAIÊñáÊ°£Âä©Êâã„ÄÇ‰Ω†ÂèØ‰ª•Ôºö<br>
                        ‚Ä¢ ÈÄâÊã©ÊñáÊ°£‰∏≠ÁöÑ‰ªªÊÑèÂÜÖÂÆπËøõË°åÁºñËæë<br>
                        ‚Ä¢ ‰ΩøÁî®Âø´ÈÄüÊìç‰ΩúËøõË°åÂ∏∏ËßÅÂ§ÑÁêÜ<br>
                        ‚Ä¢ Áõ¥Êé•‰∏éÊàëÂØπËØùËé∑ÂèñÂ∏ÆÂä©
                    </div>
                    <div class="message-time">ÂàöÂàö</div>
                    <div class="message-actions">
                        <button class="action-link" onclick="showHelp()">Êü•ÁúãÂ∏ÆÂä©</button>
                        <button class="action-link" onclick="showExamples()">Êü•ÁúãÁ§∫‰æã</button>
                    </div>
                </div>
            </div>
        `;
        AIAssistant.chatHistory = [];
        App.showNotification('info', 'ÂØπËØùÂ∑≤Ê∏ÖÈô§', 'ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
    }
}

function switchInputMode(mode) {
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
    
    if (mode === 'voice') {
        // ËØ≠Èü≥ËæìÂÖ•ÂäüËÉΩ
        App.showNotification('info', 'ËØ≠Èü≥ÂäüËÉΩ', 'ËØ≠Èü≥ËæìÂÖ•ÂäüËÉΩÂç≥Â∞ÜÊé®Âá∫');
    }
}

function toggleVoiceInput() {
    App.showNotification('info', 'ËØ≠Èü≥ÂäüËÉΩ', 'ËØ≠Èü≥ËæìÂÖ•ÂäüËÉΩÂç≥Â∞ÜÊé®Âá∫');
}

function attachFile() {
    App.showNotification('info', 'ÈôÑ‰ª∂ÂäüËÉΩ', 'Êñá‰ª∂ÈôÑ‰ª∂ÂäüËÉΩÂç≥Â∞ÜÊé®Âá∫');
}

function cancelAIProcess() {
    AIAssistant.isProcessing = false;
    AIAssistant.hideProcessing();
    App.showNotification('info', 'Â∑≤ÂèñÊ∂à', 'AIÂ§ÑÁêÜÂ∑≤ÂèñÊ∂à');
}

function sendMessage() {
    AIAssistant.sendMessage();
}

function quickAction(action) {
    AIAssistant.quickAction(action);
}

function showHelp() {
    App.showNotification('info', 'AIÂä©ÊâãÂ∏ÆÂä©', 'ÈÄâÊã©ÊñáÊ°£ÂÜÖÂÆπÂêé‰ΩøÁî®Âø´ÈÄüÊìç‰ΩúÔºåÊàñÁõ¥Êé•ËæìÂÖ•Êåá‰ª§‰∏éAIÂØπËØù');
}

function showExamples() {
    const examples = [
        '‰ºòÂåñËøôÊÆµÊñáÂ≠óÁöÑË°®Ëææ',
        'ÁøªËØë‰∏∫Ëã±Êñá',
        'ÁîüÊàêÊëòË¶Å',
        'Êâ©Â±ïÂÜÖÂÆπ',
        'Ë∞ÉÊï¥ËØ≠Ë∞É'
    ];
    
    const exampleText = examples.join('\n‚Ä¢ ');
    AIAssistant.addMessage('ai', `‰ª•‰∏ãÊòØ‰∏Ä‰∫õÂ∏∏Áî®Êåá‰ª§Á§∫‰æãÔºö\n\n‚Ä¢ ${exampleText}\n\nÊÇ®ÂèØ‰ª•Áõ¥Êé•ËæìÂÖ•Ëøô‰∫õÊåá‰ª§ÔºåÊàñÊ†πÊçÆÈúÄË¶Å‰øÆÊîπ„ÄÇ`);
}

// ÂàùÂßãÂåñÂ∫îÁî®
document.addEventListener('DOMContentLoaded', () => {
    App.init();
    AIAssistant.init();
});

// ÂÖ®Â±ÄÂáΩÊï∞Ôºà‰æõHTMLË∞ÉÁî®Ôºâ
window.App = App;

// ÂØºÂá∫Â∏∏Áî®ÂáΩÊï∞
window.openFileDialog = () => document.getElementById('hiddenFileInput').click();
window.newDocument = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'Êñ∞Âª∫ÊñáÊ°£ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');
window.openRecentFiles = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ÊúÄËøëÊñá‰ª∂ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');
window.showSettings = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ËÆæÁΩÆÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');
window.showHelp = () => App.showNotification('info', 'Â∏ÆÂä©', 'Êô∫ËÉΩÊñáÊ°£Â§ÑÁêÜÁ≥ªÁªü v1.0.0');
window.showUserMenu = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'Áî®Êà∑ËèúÂçïÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');

window.refreshFileList = () => App.loadDocumentList();
window.deleteDocument = async (docId) => {
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÊ°£ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
        try {
            const response = await fetch(`/api/document/${docId}`, { method: 'DELETE' });
            const data = await response.json();
            
            if (data.success) {
                App.showNotification('success', 'Âà†Èô§ÊàêÂäü', 'ÊñáÊ°£Â∑≤Âà†Èô§');
                App.loadDocumentList();
                
                // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÊñáÊ°£ÔºåÈáçÁΩÆÁïåÈù¢
                if (App.state.currentDocument?.document_id === docId) {
                    App.state.currentDocument = null;
                    App.elements.welcomeScreen.style.display = 'block';
                    App.elements.documentContent.style.display = 'none';
                    App.updateToolbarState();
                    App.updateDocumentTitle();
                }
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            App.showNotification('error', 'Âà†Èô§Â§±Ë¥•', error.message);
        }
    }
};

// Â∑•ÂÖ∑Ê†èÂäüËÉΩ
window.processDocument = () => {
    if (!App.state.currentDocument) {
        App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÊñáÊ°£', 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÊñáÊ°£ÂêéÂÜçËøõË°åAIÂ§ÑÁêÜ');
        return;
    }
    showModal('processModal');
};

window.enhanceDocument = async (type) => {
    if (!App.state.currentDocument) {
        App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÊñáÊ°£', 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÊñáÊ°£ÂêéÂÜçËøõË°åAIÂ¢ûÂº∫');
        return;
    }
    
    try {
        App.showProgress(0, 'AIÂ¢ûÂº∫Â§ÑÁêÜ‰∏≠...');
        
        const formData = new FormData();
        formData.append('doc_id', App.state.currentDocument.document_id);
        formData.append('enhancement_type', type);
        
        const response = await fetch('/api/ai/enhance', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            App.hideProgress();
            App.showNotification('success', 'AIÂ¢ûÂº∫ÂÆåÊàê', `ÊñáÊ°£Â∑≤‰ΩøÁî®${type}È£éÊ†ºËøõË°å‰ºòÂåñ`);
            
            // ÈáçÊñ∞Âä†ËΩΩÊñáÊ°£ÂÜÖÂÆπ
            App.selectDocument(App.state.currentDocument.document_id);
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        App.hideProgress();
        App.showNotification('error', 'AIÂ¢ûÂº∫Â§±Ë¥•', error.message);
    }
};

window.showExportOptions = () => {
    if (!App.state.currentDocument) {
        App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÊñáÊ°£', 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™Â∑≤Â§ÑÁêÜÁöÑÊñáÊ°£ÂêéÂÜçÂØºÂá∫');
        return;
    }
    showModal('exportModal');
};

window.shareDocument = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ÊñáÊ°£ÂàÜ‰∫´ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');

// Áº©ÊîæÊéßÂà∂
window.zoomIn = () => {
    App.state.zoomLevel = Math.min(App.state.zoomLevel + 10, 200);
    App.elements.zoomLevel.textContent = `${App.state.zoomLevel}%`;
    App.elements.documentViewer.style.zoom = App.state.zoomLevel / 100;
};

window.zoomOut = () => {
    App.state.zoomLevel = Math.max(App.state.zoomLevel - 10, 50);
    App.elements.zoomLevel.textContent = `${App.state.zoomLevel}%`;
    App.elements.documentViewer.style.zoom = App.state.zoomLevel / 100;
};

// Ê†áÁ≠æÈ°µÂàáÊç¢
window.switchTab = (tabName) => {
    // ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    App.state.activeTab = tabName;
};

// ‰∏ãÊãâËèúÂçïÊéßÂà∂
window.toggleFileMenu = () => {
    const menu = document.getElementById('fileMenu');
    menu.classList.toggle('show');
};

window.toggleEnhanceMenu = () => {
    const menu = document.getElementById('enhanceMenu');
    menu.classList.toggle('show');
};

// Ê®°ÊÄÅÊ°ÜÊéßÂà∂
window.showModal = (modalId) => {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
};

window.closeModal = (modalId) => {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
};

// Â±ûÊÄßÈù¢ÊùøÊéßÂà∂
window.togglePropertiesPanel = () => {
    const panel = document.getElementById('propertiesPanel');
    panel.classList.toggle('show');
};

// ÊñáÊ°£Êìç‰Ωú
window.editDocument = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ÊñáÊ°£ÁºñËæëÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');
window.previewDocument = () => App.showNotification('info', 'ÂäüËÉΩÂºÄÂèë‰∏≠', 'ÊñáÊ°£È¢ÑËßàÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠');

console.log('üéØ Â∫îÁî®Ê†∏ÂøÉÊ®°ÂùóÂ∑≤Âä†ËΩΩ');