/**
 * Rich Text Editor - ÂØåÊñáÊú¨ÁºñËæëÂô®Ê†∏ÂøÉÂäüËÉΩ
 */

class RichTextEditor {
    constructor(containerSelector) {
        this.container = document.querySelector(containerSelector);
        this.editor = null;
        this.toolbar = null;
        this.outline = null;
        this.contextMenu = null;
        
        // ÁºñËæëÂô®Áä∂ÊÄÅ
        this.currentDocument = null;
        this.isEditing = false;
        this.selectedText = '';
        this.selectedElement = null;
        this.versions = [];
        this.currentVersion = 0;
        
        // ÂàùÂßãÂåñÁºñËæëÂô®
        this.init();
    }
    
    init() {
        this.createEditor();
        this.createToolbar();
        this.createOutline();
        this.createContextMenu();
        this.bindEvents();
        
        console.log('üìù ÂØåÊñáÊú¨ÁºñËæëÂô®Â∑≤ÂàùÂßãÂåñ');
    }
    
    createEditor() {
        const editorHTML = `
            <div class="editor-container">
                <div class="editor-toolbar" id="editorToolbar">
                    <!-- Â∑•ÂÖ∑Ê†èÂ∞ÜÂä®ÊÄÅÂàõÂª∫ -->
                </div>
                <div class="editor-content">
                    <div class="outline-sidebar" id="outlineSidebar">
                        <div class="outline-header">
                            <span>ÊñáÊ°£Â§ßÁ∫≤</span>
                            <button class="icon-btn small" onclick="toggleOutline()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="outline-content" id="outlineContent">
                            <!-- Â§ßÁ∫≤ÂÜÖÂÆπ -->
                        </div>
                    </div>
                    <div class="editor-main">
                        <div class="editor-area">
                            <div class="editor-document" 
                                 id="editorDocument" 
                                 contenteditable="true"
                                 data-placeholder="ÂºÄÂßãËæìÂÖ•ÊÇ®ÁöÑÊñáÊ°£ÂÜÖÂÆπ...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Âè≥ÈîÆËèúÂçï -->
            <div class="context-menu" id="contextMenu">
                <!-- Âè≥ÈîÆËèúÂçïÈ°πÂ∞ÜÂä®ÊÄÅÂàõÂª∫ -->
            </div>
            
            <!-- LLMÊìç‰ΩúÈù¢Êùø -->
            <div class="llm-panel" id="llmPanel">
                <div class="llm-panel-header">
                    <span class="llm-panel-title">AIÊñáÊú¨Â§ÑÁêÜ</span>
                    <button class="llm-panel-close" onclick="closeLLMPanel()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="llm-panel-content">
                    <div class="llm-action-grid">
                        <button class="llm-action-btn" onclick="llmAction('polish')">
                            <i class="fas fa-magic"></i>
                            <span>Ê∂¶Ëâ≤</span>
                        </button>
                        <button class="llm-action-btn" onclick="llmAction('expand')">
                            <i class="fas fa-expand-arrows-alt"></i>
                            <span>Êâ©ÂÜô</span>
                        </button>
                        <button class="llm-action-btn" onclick="llmAction('summarize')">
                            <i class="fas fa-compress-alt"></i>
                            <span>Áº©ÂÜô</span>
                        </button>
                        <button class="llm-action-btn" onclick="llmAction('translate')">
                            <i class="fas fa-language"></i>
                            <span>ÁøªËØë</span>
                        </button>
                        <button class="llm-action-btn" onclick="llmAction('formal')">
                            <i class="fas fa-user-tie"></i>
                            <span>Ê≠£ÂºèÂåñ</span>
                        </button>
                        <button class="llm-action-btn" onclick="llmAction('casual')">
                            <i class="fas fa-smile"></i>
                            <span>Âè£ËØ≠Âåñ</span>
                        </button>
                    </div>
                    <textarea class="llm-custom-input" id="llmCustomInput" 
                              placeholder="ËæìÂÖ•Ëá™ÂÆö‰πâÊåá‰ª§..."></textarea>
                </div>
                <div class="llm-panel-footer">
                    <button class="btn secondary" onclick="closeLLMPanel()">ÂèñÊ∂à</button>
                    <button class="btn primary" onclick="executeLLMAction()">ÊâßË°å</button>
                </div>
            </div>
            
            <!-- ÁâàÊú¨ÂéÜÂè≤ -->
            <div class="version-history" id="versionHistory">
                <div class="version-history-header">
                    <span class="version-history-title">ÁâàÊú¨ÂéÜÂè≤</span>
                    <button class="icon-btn small" onclick="toggleVersionHistory()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="version-history-content" id="versionHistoryContent">
                    <!-- ÁâàÊú¨ÂéÜÂè≤ÂÜÖÂÆπ -->
                </div>
            </div>
        `;
        
        this.container.innerHTML = editorHTML;
        this.editor = document.getElementById('editorDocument');
        this.toolbar = document.getElementById('editorToolbar');
        this.outline = document.getElementById('outlineContent');
        this.contextMenu = document.getElementById('contextMenu');
    }
    
    createToolbar() {
        const toolbarHTML = `
            <!-- Êñá‰ª∂Êìç‰Ωú -->
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="newDocument()" title="Êñ∞Âª∫">
                    <i class="fas fa-file-plus"></i>
                </button>
                <button class="toolbar-btn" onclick="openDocument()" title="ÊâìÂºÄ">
                    <i class="fas fa-folder-open"></i>
                </button>
                <button class="toolbar-btn" onclick="saveDocument()" title="‰øùÂ≠ò">
                    <i class="fas fa-save"></i>
                </button>
            </div>
            
            <!-- Êí§ÈîÄÈáçÂÅö -->
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="undo()" title="Êí§ÈîÄ">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="toolbar-btn" onclick="redo()" title="ÈáçÂÅö">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            
            <!-- Â≠ó‰ΩìËÆæÁΩÆ -->
            <div class="toolbar-group">
                <select class="toolbar-select" id="fontFamily" onchange="changeFontFamily(this.value)">
                    <option value="Inter">Inter</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                </select>
                <select class="toolbar-select" id="fontSize" onchange="changeFontSize(this.value)">
                    <option value="12">12px</option>
                    <option value="14" selected>14px</option>
                    <option value="16">16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                    <option value="24">24px</option>
                    <option value="28">28px</option>
                    <option value="32">32px</option>
                </select>
            </div>
            
            <!-- ÊñáÊú¨Ê†ºÂºè -->
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="toggleBold()" title="Âä†Á≤ó">
                    <i class="fas fa-bold"></i>
                </button>
                <button class="toolbar-btn" onclick="toggleItalic()" title="Êñú‰Ωì">
                    <i class="fas fa-italic"></i>
                </button>
                <button class="toolbar-btn" onclick="toggleUnderline()" title="‰∏ãÂàíÁ∫ø">
                    <i class="fas fa-underline"></i>
                </button>
                <button class="toolbar-btn" onclick="toggleStrikethrough()" title="Âà†Èô§Á∫ø">
                    <i class="fas fa-strikethrough"></i>
                </button>
            </div>
            
            <!-- È¢úËâ≤ -->
            <div class="toolbar-group">
                <div class="color-picker">
                    <div class="color-preview" id="textColorPreview" 
                         style="background: #000000" onclick="toggleColorPicker('text')"></div>
                    <div class="color-dropdown" id="textColorDropdown">
                        <div class="color-grid" id="textColorGrid"></div>
                        <input type="color" id="textColorCustom" onchange="setTextColor(this.value)">
                    </div>
                </div>
                <div class="color-picker">
                    <div class="color-preview" id="bgColorPreview" 
                         style="background: #ffffff" onclick="toggleColorPicker('bg')"></div>
                    <div class="color-dropdown" id="bgColorDropdown">
                        <div class="color-grid" id="bgColorGrid"></div>
                        <input type="color" id="bgColorCustom" onchange="setBackgroundColor(this.value)">
                    </div>
                </div>
            </div>
            
            <!-- ÂØπÈΩê -->
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="setAlignment('left')" title="Â∑¶ÂØπÈΩê">
                    <i class="fas fa-align-left"></i>
                </button>
                <button class="toolbar-btn" onclick="setAlignment('center')" title="Â±Ö‰∏≠">
                    <i class="fas fa-align-center"></i>
                </button>
                <button class="toolbar-btn" onclick="setAlignment('right')" title="Âè≥ÂØπÈΩê">
                    <i class="fas fa-align-right"></i>
                </button>
                <button class="toolbar-btn" onclick="setAlignment('justify')" title="‰∏§Á´ØÂØπÈΩê">
                    <i class="fas fa-align-justify"></i>
                </button>
            </div>
            
            <!-- ÂàóË°® -->
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="toggleList('ul')" title="Êó†Â∫èÂàóË°®">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button class="toolbar-btn" onclick="toggleList('ol')" title="ÊúâÂ∫èÂàóË°®">
                    <i class="fas fa-list-ol"></i>
                </button>
                <button class="toolbar-btn" onclick="decreaseIndent()" title="ÂáèÂ∞ëÁº©Ëøõ">
                    <i class="fas fa-outdent"></i>
                </button>
                <button class="toolbar-btn" onclick="increaseIndent()" title="Â¢ûÂä†Áº©Ëøõ">
                    <i class="fas fa-indent"></i>
                </button>
            </div>
            
            <!-- ÊèíÂÖ•ÂÖÉÁ¥† -->
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="insertTable()" title="ÊèíÂÖ•Ë°®Ê†º">
                    <i class="fas fa-table"></i>
                </button>
                <button class="toolbar-btn" onclick="insertImage()" title="ÊèíÂÖ•ÂõæÁâá">
                    <i class="fas fa-image"></i>
                </button>
                <button class="toolbar-btn" onclick="insertLink()" title="ÊèíÂÖ•ÈìæÊé•">
                    <i class="fas fa-link"></i>
                </button>
            </div>
            
            <!-- Ê†áÈ¢ò -->
            <div class="toolbar-group">
                <select class="toolbar-select" id="headingLevel" onchange="setHeading(this.value)">
                    <option value="">Ê≠£Êñá</option>
                    <option value="h1">Ê†áÈ¢ò 1</option>
                    <option value="h2">Ê†áÈ¢ò 2</option>
                    <option value="h3">Ê†áÈ¢ò 3</option>
                    <option value="h4">Ê†áÈ¢ò 4</option>
                    <option value="h5">Ê†áÈ¢ò 5</option>
                    <option value="h6">Ê†áÈ¢ò 6</option>
                </select>
            </div>
            
            <!-- AIÂäüËÉΩ -->
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="openLLMPanel()" title="AIÂ§ÑÁêÜ">
                    <i class="fas fa-robot"></i>
                </button>
                <button class="toolbar-btn" onclick="toggleVersionHistory()" title="ÁâàÊú¨ÂéÜÂè≤">
                    <i class="fas fa-history"></i>
                </button>
            </div>
        `;
        
        this.toolbar.innerHTML = toolbarHTML;
        this.initColorPickers();
    }
    
    initColorPickers() {
        const colors = [
            '#000000', '#434343', '#666666', '#999999', '#B7B7B7', '#CCCCCC', '#D9D9D9', '#EFEFEF',
            '#F3F3F3', '#FFFFFF', '#980000', '#FF0000', '#FF9900', '#FFFF00', '#00FF00', '#00FFFF',
            '#4A86E8', '#0000FF', '#9900FF', '#FF00FF', '#E6B8AF', '#F4CCCC', '#FCE5CD', '#FFF2CC',
            '#D9EAD3', '#D0E0E3', '#C9DAF8', '#CFE2F3', '#D9D2E9', '#EAD1DC'
        ];
        
        ['textColorGrid', 'bgColorGrid'].forEach(gridId => {
            const grid = document.getElementById(gridId);
            if (grid) {
                grid.innerHTML = colors.map(color => 
                    `<div class="color-option" style="background: ${color}" 
                          onclick="setColor('${gridId.includes('text') ? 'text' : 'bg'}', '${color}')"></div>`
                ).join('');
            }
        });
    }
    
    createOutline() {
        // Â§ßÁ∫≤Â∞ÜÂú®ÊñáÊ°£ÂÜÖÂÆπÂèòÂåñÊó∂Âä®ÊÄÅÊõ¥Êñ∞
        this.updateOutline();
    }
    
    createContextMenu() {
        const menuHTML = `
            <button class="context-menu-item" onclick="cutText()">
                <i class="fas fa-cut"></i>
                Ââ™Âàá
            </button>
            <button class="context-menu-item" onclick="copyText()">
                <i class="fas fa-copy"></i>
                Â§çÂà∂
            </button>
            <button class="context-menu-item" onclick="pasteText()">
                <i class="fas fa-paste"></i>
                Á≤òË¥¥
            </button>
            <div class="context-menu-divider"></div>
            <button class="context-menu-item" onclick="openLLMPanel()">
                <i class="fas fa-magic"></i>
                AIÊ∂¶Ëâ≤
            </button>
            <button class="context-menu-item" onclick="llmAction('translate')">
                <i class="fas fa-language"></i>
                ÁøªËØë
            </button>
            <button class="context-menu-item" onclick="llmAction('explain')">
                <i class="fas fa-question-circle"></i>
                Ëß£Èáä
            </button>
            <div class="context-menu-divider"></div>
            <button class="context-menu-item" onclick="selectAll()">
                <i class="fas fa-check-square"></i>
                ÂÖ®ÈÄâ
            </button>
        `;
        
        this.contextMenu.innerHTML = menuHTML;
    }
    
    bindEvents() {
        // ÁºñËæëÂô®‰∫ã‰ª∂
        this.editor.addEventListener('input', this.handleInput.bind(this));
        this.editor.addEventListener('keydown', this.handleKeydown.bind(this));
        this.editor.addEventListener('mouseup', this.handleSelection.bind(this));
        this.editor.addEventListener('keyup', this.handleSelection.bind(this));
        this.editor.addEventListener('contextmenu', this.handleContextMenu.bind(this));
        this.editor.addEventListener('paste', this.handlePaste.bind(this));
        
        // ÂÖ®Â±Ä‰∫ã‰ª∂
        document.addEventListener('click', this.handleDocumentClick.bind(this));
        document.addEventListener('keydown', this.handleGlobalKeydown.bind(this));
        
        // ÂõæÁâáÂíåË°®Ê†º‰∫ã‰ª∂ÂßîÊâò
        this.editor.addEventListener('click', this.handleElementClick.bind(this));
        
        // Ëá™Âä®‰øùÂ≠ò
        setInterval(() => {
            this.autoSave();
        }, 30000); // 30ÁßíËá™Âä®‰øùÂ≠ò
    }
    
    handleInput(event) {
        this.updateOutline();
        this.markUnsaved();
        
        // Âª∂ËøüÂàõÂª∫ÁâàÊú¨Âø´ÁÖß
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => {
            this.createVersionSnapshot('ÊñáÊ°£ÁºñËæë');
        }, 2000);
    }
    
    handleKeydown(event) {
        // Âø´Êç∑ÈîÆÂ§ÑÁêÜ
        if (event.ctrlKey || event.metaKey) {
            switch (event.key) {
                case 'b':
                    event.preventDefault();
                    this.toggleBold();
                    break;
                case 'i':
                    event.preventDefault();
                    this.toggleItalic();
                    break;
                case 'u':
                    event.preventDefault();
                    this.toggleUnderline();
                    break;
                case 's':
                    event.preventDefault();
                    this.saveDocument();
                    break;
                case 'z':
                    event.preventDefault();
                    if (event.shiftKey) {
                        this.redo();
                    } else {
                        this.undo();
                    }
                    break;
                case 'y':
                    event.preventDefault();
                    this.redo();
                    break;
            }
        }
        
        // TabÈîÆÁº©Ëøõ
        if (event.key === 'Tab') {
            event.preventDefault();
            if (event.shiftKey) {
                this.decreaseIndent();
            } else {
                this.increaseIndent();
            }
        }
    }
    
    handleSelection(event) {
        const selection = window.getSelection();
        this.selectedText = selection.toString();
        
        // Êõ¥Êñ∞Â∑•ÂÖ∑Ê†èÁä∂ÊÄÅ
        this.updateToolbarState();
        
        // Êõ¥Êñ∞AIÈù¢Êùø‰∏≠ÁöÑÈÄâ‰∏≠ÊñáÊú¨
        if (this.selectedText && AIAssistant) {
            AIAssistant.showSelectedContent(this.selectedText);
        }
    }
    
    handleContextMenu(event) {
        event.preventDefault();
        
        const selection = window.getSelection();
        if (selection.toString().trim()) {
            this.selectedText = selection.toString();
            this.showContextMenu(event.clientX, event.clientY);
        }
    }
    
    handlePaste(event) {
        event.preventDefault();
        
        const clipboardData = event.clipboardData || window.clipboardData;
        const htmlData = clipboardData.getData('text/html');
        const textData = clipboardData.getData('text/plain');
        
        if (htmlData) {
            // Ê∏ÖÁêÜHTMLÂÜÖÂÆπ
            const cleanHTML = this.cleanPastedHTML(htmlData);
            document.execCommand('insertHTML', false, cleanHTML);
        } else if (textData) {
            document.execCommand('insertText', false, textData);
        }
        
        this.updateOutline();
    }
    
    handleDocumentClick(event) {
        // ÂÖ≥Èó≠È¢úËâ≤ÈÄâÊã©Âô®
        if (!event.target.closest('.color-picker')) {
            document.querySelectorAll('.color-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
        
        // ÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
        if (!event.target.closest('.context-menu')) {
            this.hideContextMenu();
        }
    }
    
    handleGlobalKeydown(event) {
        // ESCÈîÆÂÖ≥Èó≠Èù¢Êùø
        if (event.key === 'Escape') {
            this.hideContextMenu();
            this.closeLLMPanel();
        }
    }
    
    handleElementClick(event) {
        const target = event.target;
        
        // ÂõæÁâáÁÇπÂáªÂ§ÑÁêÜ
        if (target.tagName === 'IMG') {
            this.selectImage(target);
        }
        
        // Ë°®Ê†ºÁÇπÂáªÂ§ÑÁêÜ
        if (target.closest('.table-editor')) {
            this.selectTable(target.closest('.table-editor'));
        }
    }
    
    // Âü∫Á°ÄÁºñËæëÂäüËÉΩ
    toggleBold() {
        document.execCommand('bold');
        this.updateToolbarState();
    }
    
    toggleItalic() {
        document.execCommand('italic');
        this.updateToolbarState();
    }
    
    toggleUnderline() {
        document.execCommand('underline');
        this.updateToolbarState();
    }
    
    toggleStrikethrough() {
        document.execCommand('strikeThrough');
        this.updateToolbarState();
    }
    
    changeFontFamily(font) {
        document.execCommand('fontName', false, font);
    }
    
    changeFontSize(size) {
        document.execCommand('fontSize', false, '7');
        const fontElements = document.querySelectorAll('font[size="7"]');
        fontElements.forEach(el => {
            el.removeAttribute('size');
            el.style.fontSize = size + 'px';
        });
    }
    
    setAlignment(align) {
        const commands = {
            'left': 'justifyLeft',
            'center': 'justifyCenter',
            'right': 'justifyRight',
            'justify': 'justifyFull'
        };
        
        document.execCommand(commands[align]);
        this.updateToolbarState();
    }
    
    toggleList(type) {
        const command = type === 'ul' ? 'insertUnorderedList' : 'insertOrderedList';
        document.execCommand(command);
        this.updateToolbarState();
    }
    
    increaseIndent() {
        document.execCommand('indent');
    }
    
    decreaseIndent() {
        document.execCommand('outdent');
    }
    
    setHeading(level) {
        if (level) {
            document.execCommand('formatBlock', false, level);
        } else {
            document.execCommand('formatBlock', false, 'p');
        }
        this.updateOutline();
        this.updateToolbarState();
    }
    
    // È¢úËâ≤ËÆæÁΩÆ
    setColor(type, color) {
        if (type === 'text') {
            document.execCommand('foreColor', false, color);
            document.getElementById('textColorPreview').style.background = color;
        } else {
            document.execCommand('backColor', false, color);
            document.getElementById('bgColorPreview').style.background = color;
        }
        
        this.toggleColorPicker(type);
    }
    
    toggleColorPicker(type) {
        const dropdown = document.getElementById(type + 'ColorDropdown');
        dropdown.classList.toggle('show');
    }
    
    // ÊèíÂÖ•ÂÖÉÁ¥†
    insertTable() {
        const rows = prompt('ËØ∑ËæìÂÖ•Ë°åÊï∞:', '3');
        const cols = prompt('ËØ∑ËæìÂÖ•ÂàóÊï∞:', '3');
        
        if (rows && cols) {
            const table = this.createTable(parseInt(rows), parseInt(cols));
            this.insertHTML(table);
        }
    }
    
    createTable(rows, cols) {
        let tableHTML = '<table class="table-editor"><tbody>';
        
        for (let i = 0; i < rows; i++) {
            tableHTML += '<tr>';
            for (let j = 0; j < cols; j++) {
                const tag = i === 0 ? 'th' : 'td';
                tableHTML += `<${tag} contenteditable="true">${i === 0 ? `Âàó ${j + 1}` : ''}</${tag}>`;
            }
            tableHTML += '</tr>';
        }
        
        tableHTML += '</tbody></table>';
        return tableHTML;
    }
    
    insertImage() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = `<div class="image-wrapper">
                        <img src="${e.target.result}" alt="ÊèíÂÖ•ÁöÑÂõæÁâá" style="max-width: 100%; height: auto;">
                        <div class="image-controls">
                            <button class="image-control-btn" onclick="resizeImage(this)">Ë∞ÉÊï¥</button>
                            <button class="image-control-btn" onclick="deleteImage(this)">Âà†Èô§</button>
                        </div>
                        <div class="image-resize-handle nw"></div>
                        <div class="image-resize-handle ne"></div>
                        <div class="image-resize-handle sw"></div>
                        <div class="image-resize-handle se"></div>
                    </div>`;
                    this.insertHTML(img);
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    }
    
    insertLink() {
        const url = prompt('ËØ∑ËæìÂÖ•ÈìæÊé•Âú∞ÂùÄ:');
        const text = this.selectedText || prompt('ËØ∑ËæìÂÖ•ÈìæÊé•ÊñáÂ≠ó:');
        
        if (url && text) {
            const link = `<a href="${url}" target="_blank">${text}</a>`;
            this.insertHTML(link);
        }
    }
    
    insertHTML(html) {
        if (document.queryCommandSupported('insertHTML')) {
            document.execCommand('insertHTML', false, html);
        } else {
            // Fallback for browsers that don't support insertHTML
            const selection = window.getSelection();
            if (selection.getRangeAt && selection.rangeCount) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                
                const el = document.createElement('div');
                el.innerHTML = html;
                const frag = document.createDocumentFragment();
                let node;
                while ((node = el.firstChild)) {
                    frag.appendChild(node);
                }
                range.insertNode(frag);
            }
        }
    }
    
    // Â§ßÁ∫≤Êõ¥Êñ∞
    updateOutline() {
        const headings = this.editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const outlineHTML = Array.from(headings).map((heading, index) => {
            const level = heading.tagName.toLowerCase();
            const text = heading.textContent.trim();
            return text ? `
                <div class="outline-item ${level}" onclick="scrollToHeading(${index})">
                    ${text}
                </div>
            ` : '';
        }).join('');
        
        this.outline.innerHTML = outlineHTML || '<div class="empty-state">ÊöÇÊó†Ê†áÈ¢ò</div>';
    }
    
    // Â∑•ÂÖ∑Ê†èÁä∂ÊÄÅÊõ¥Êñ∞
    updateToolbarState() {
        // Êõ¥Êñ∞ÊåâÈíÆÊøÄÊ¥ªÁä∂ÊÄÅ
        const commands = ['bold', 'italic', 'underline', 'strikeThrough'];
        commands.forEach(cmd => {
            const btn = this.toolbar.querySelector(`[onclick*="${cmd}"]`);
            if (btn) {
                btn.classList.toggle('active', document.queryCommandState(cmd));
            }
        });
        
        // Êõ¥Êñ∞Â≠ó‰ΩìÂíåÂ≠óÂè∑
        try {
            const fontFamily = document.queryCommandValue('fontName');
            if (fontFamily) {
                const fontSelect = document.getElementById('fontFamily');
                if (fontSelect) fontSelect.value = fontFamily;
            }
        } catch (e) {
            // Ignore errors
        }
    }
    
    // Âè≥ÈîÆËèúÂçï
    showContextMenu(x, y) {
        this.contextMenu.style.left = x + 'px';
        this.contextMenu.style.top = y + 'px';
        this.contextMenu.classList.add('show');
    }
    
    hideContextMenu() {
        this.contextMenu.classList.remove('show');
    }
    
    // ÁâàÊú¨ÁÆ°ÁêÜ
    createVersionSnapshot(description) {
        const snapshot = {
            id: Date.now(),
            content: this.editor.innerHTML,
            description: description || 'Ëá™Âä®‰øùÂ≠ò',
            timestamp: new Date().toISOString(),
            isCurrent: false
        };
        
        // Ê†áËÆ∞‰πãÂâçÁöÑÁâàÊú¨‰∏∫ÈùûÂΩìÂâçÁâàÊú¨
        this.versions.forEach(v => v.isCurrent = false);
        snapshot.isCurrent = true;
        
        this.versions.push(snapshot);
        
        // ÈôêÂà∂ÁâàÊú¨Êï∞Èáè
        if (this.versions.length > 50) {
            this.versions = this.versions.slice(-50);
        }
        
        this.updateVersionHistory();
        this.currentVersion = this.versions.length - 1;
    }
    
    updateVersionHistory() {
        const historyContent = document.getElementById('versionHistoryContent');
        if (!historyContent) return;
        
        const historyHTML = this.versions.map((version, index) => `
            <div class="version-item ${version.isCurrent ? 'current' : ''}" 
                 onclick="restoreVersion(${index})">
                <div class="version-time">${new Date(version.timestamp).toLocaleString()}</div>
                <div class="version-description">${version.description}</div>
            </div>
        `).reverse().join('');
        
        historyContent.innerHTML = historyHTML || '<div class="empty-state">ÊöÇÊó†ÁâàÊú¨ÂéÜÂè≤</div>';
    }
    
    restoreVersion(index) {
        if (index >= 0 && index < this.versions.length) {
            const version = this.versions[index];
            this.editor.innerHTML = version.content;
            
            // Ê†áËÆ∞‰∏∫ÂΩìÂâçÁâàÊú¨
            this.versions.forEach(v => v.isCurrent = false);
            version.isCurrent = true;
            
            this.currentVersion = index;
            this.updateVersionHistory();
            this.updateOutline();
            
            App.showNotification('success', 'ÁâàÊú¨ÊÅ¢Â§ç', 'Â∑≤ÊÅ¢Â§çÂà∞ÈÄâÂÆöÁâàÊú¨');
        }
    }
    
    // Ëá™Âä®‰øùÂ≠ò
    autoSave() {
        if (this.editor.innerHTML.trim()) {
            this.createVersionSnapshot('Ëá™Âä®‰øùÂ≠ò');
            localStorage.setItem('editor_autosave', JSON.stringify({
                content: this.editor.innerHTML,
                timestamp: new Date().toISOString()
            }));
        }
    }
    
    // ÊñáÊ°£Êìç‰Ωú
    newDocument() {
        if (confirm('Á°ÆÂÆöË¶ÅÊñ∞Âª∫ÊñáÊ°£ÂêóÔºüÊú™‰øùÂ≠òÁöÑÂÜÖÂÆπÂ∞Ü‰∏¢Â§±„ÄÇ')) {
            this.editor.innerHTML = '';
            this.versions = [];
            this.currentDocument = null;
            this.updateOutline();
            this.createVersionSnapshot('Êñ∞Âª∫ÊñáÊ°£');
        }
    }
    
    saveDocument() {
        const content = this.editor.innerHTML;
        const title = this.getDocumentTitle();
        
        // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®ÂêéÁ´ØAPI‰øùÂ≠òÊñáÊ°£
        // ÊöÇÊó∂‰øùÂ≠òÂà∞localStorage
        const doc = {
            title: title,
            content: content,
            lastModified: new Date().toISOString()
        };
        
        localStorage.setItem('current_document', JSON.stringify(doc));
        this.createVersionSnapshot('ÊâãÂä®‰øùÂ≠ò');
        
        App.showNotification('success', '‰øùÂ≠òÊàêÂäü', 'ÊñáÊ°£Â∑≤‰øùÂ≠ò');
    }
    
    getDocumentTitle() {
        const firstHeading = this.editor.querySelector('h1, h2, h3');
        return firstHeading ? firstHeading.textContent.trim() : 'Êú™ÂëΩÂêçÊñáÊ°£';
    }
    
    // HTMLÊ∏ÖÁêÜ
    cleanPastedHTML(html) {
        // ÂàõÂª∫‰∏¥Êó∂ÂÖÉÁ¥†Êù•Ê∏ÖÁêÜHTML
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // ÁßªÈô§Âç±Èô©ÁöÑÊ†áÁ≠æÂíåÂ±ûÊÄß
        const dangerousTags = ['script', 'style', 'link', 'meta'];
        dangerousTags.forEach(tag => {
            const elements = temp.querySelectorAll(tag);
            elements.forEach(el => el.remove());
        });
        
        // Ê∏ÖÁêÜÂ±ûÊÄß
        const allElements = temp.querySelectorAll('*');
        allElements.forEach(el => {
            // ‰øùÁïôÂü∫Êú¨Ê†∑ÂºèÂ±ûÊÄß
            const allowedAttrs = ['style', 'href', 'src', 'alt', 'title'];
            const attrs = Array.from(el.attributes);
            attrs.forEach(attr => {
                if (!allowedAttrs.includes(attr.name)) {
                    el.removeAttribute(attr.name);
                }
            });
        });
        
        return temp.innerHTML;
    }
    
    // Êí§ÈîÄÈáçÂÅö
    undo() {
        document.execCommand('undo');
    }
    
    redo() {
        document.execCommand('redo');
    }
    
    // Ê†áËÆ∞ÊñáÊ°£‰∏∫Êú™‰øùÂ≠òÁä∂ÊÄÅ
    markUnsaved() {
        // ÂèØ‰ª•Âú®Ê†áÈ¢òÊ†èÊòæÁ§∫Êú™‰øùÂ≠òÊ†áËØÜ
        const title = document.title;
        if (!title.includes('*')) {
            document.title = title + ' *';
        }
    }
    
    // Ëé∑ÂèñÁºñËæëÂô®ÂÜÖÂÆπ
    getContent() {
        return this.editor.innerHTML;
    }
    
    // ËÆæÁΩÆÁºñËæëÂô®ÂÜÖÂÆπ
    setContent(html) {
        this.editor.innerHTML = html;
        this.updateOutline();
    }
    
    // Ëé∑ÂèñÁ∫ØÊñáÊú¨ÂÜÖÂÆπ
    getTextContent() {
        return this.editor.textContent;
    }
    
    // ÊèíÂÖ•ÊñáÊú¨
    insertText(text) {
        document.execCommand('insertText', false, text);
    }
}

// ÂÖ®Â±ÄÁºñËæëÂô®ÂÆû‰æã
let richTextEditor = null;

// ÂàùÂßãÂåñÁºñËæëÂô®
function initRichTextEditor() {
    richTextEditor = new RichTextEditor('.document-area');
    
    // Âä†ËΩΩËá™Âä®‰øùÂ≠òÁöÑÂÜÖÂÆπ
    const autosave = localStorage.getItem('editor_autosave');
    if (autosave) {
        try {
            const data = JSON.parse(autosave);
            richTextEditor.setContent(data.content);
            App.showNotification('info', 'Ëá™Âä®ÊÅ¢Â§ç', 'Â∑≤ÊÅ¢Â§çËá™Âä®‰øùÂ≠òÁöÑÂÜÖÂÆπ');
        } catch (e) {
            console.error('Failed to load autosave:', e);
        }
    }
}

// Â∑•ÂÖ∑Ê†èÂäüËÉΩÂáΩÊï∞ (ÂÖ®Â±Ä)
function toggleBold() { richTextEditor?.toggleBold(); }
function toggleItalic() { richTextEditor?.toggleItalic(); }
function toggleUnderline() { richTextEditor?.toggleUnderline(); }
function toggleStrikethrough() { richTextEditor?.toggleStrikethrough(); }
function changeFontFamily(font) { richTextEditor?.changeFontFamily(font); }
function changeFontSize(size) { richTextEditor?.changeFontSize(size); }
function setAlignment(align) { richTextEditor?.setAlignment(align); }
function toggleList(type) { richTextEditor?.toggleList(type); }
function increaseIndent() { richTextEditor?.increaseIndent(); }
function decreaseIndent() { richTextEditor?.decreaseIndent(); }
function setHeading(level) { richTextEditor?.setHeading(level); }
function insertTable() { richTextEditor?.insertTable(); }
function insertImage() { richTextEditor?.insertImage(); }
function insertLink() { richTextEditor?.insertLink(); }
function newDocument() { richTextEditor?.newDocument(); }
function saveDocument() { richTextEditor?.saveDocument(); }
function undo() { richTextEditor?.undo(); }
function redo() { richTextEditor?.redo(); }

// È¢úËâ≤ËÆæÁΩÆ
function setColor(type, color) { richTextEditor?.setColor(type, color); }
function toggleColorPicker(type) { richTextEditor?.toggleColorPicker(type); }
function setTextColor(color) { setColor('text', color); }
function setBackgroundColor(color) { setColor('bg', color); }

// Âè≥ÈîÆËèúÂçïÂäüËÉΩ
function cutText() { document.execCommand('cut'); }
function copyText() { document.execCommand('copy'); }
function pasteText() { document.execCommand('paste'); }
function selectAll() { document.execCommand('selectAll'); }

// Â§ßÁ∫≤ÂØºËà™
function scrollToHeading(index) {
    const headings = document.querySelectorAll('#editorDocument h1, #editorDocument h2, #editorDocument h3, #editorDocument h4, #editorDocument h5, #editorDocument h6');
    if (headings[index]) {
        headings[index].scrollIntoView({ behavior: 'smooth' });
    }
}

// ÁâàÊú¨ÂéÜÂè≤
function restoreVersion(index) { richTextEditor?.restoreVersion(index); }
function toggleVersionHistory() {
    const versionHistory = document.getElementById('versionHistory');
    versionHistory?.classList.toggle('show');
}

// Â§ßÁ∫≤ÂàáÊç¢
function toggleOutline() {
    const outline = document.getElementById('outlineSidebar');
    outline?.classList.toggle('show');
}

// LLMÈù¢ÊùøÊéßÂà∂
function openLLMPanel() {
    const panel = document.getElementById('llmPanel');
    panel?.classList.add('show');
}

function closeLLMPanel() {
    const panel = document.getElementById('llmPanel');
    panel?.classList.remove('show');
}

// ÂõæÁâáÊìç‰Ωú
function selectImage(img) {
    // ÁßªÈô§ÂÖ∂‰ªñÂõæÁâáÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
    document.querySelectorAll('.image-wrapper.selected').forEach(wrapper => {
        wrapper.classList.remove('selected');
    });
    
    // ÈÄâ‰∏≠ÂΩìÂâçÂõæÁâá
    const wrapper = img.closest('.image-wrapper');
    if (wrapper) {
        wrapper.classList.add('selected');
    }
}

function resizeImage(btn) {
    const wrapper = btn.closest('.image-wrapper');
    const img = wrapper?.querySelector('img');
    if (img) {
        const newWidth = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂÆΩÂ∫¶(px):', img.style.width || img.offsetWidth);
        if (newWidth) {
            img.style.width = newWidth + 'px';
            img.style.height = 'auto';
        }
    }
}

function deleteImage(btn) {
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºü')) {
        const wrapper = btn.closest('.image-wrapper');
        wrapper?.remove();
    }
}

// Ë°®Ê†ºÊìç‰Ωú
function selectTable(table) {
    // ÁßªÈô§ÂÖ∂‰ªñË°®Ê†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
    document.querySelectorAll('.table-editor.selected').forEach(t => {
        t.classList.remove('selected');
    });
    
    // ÈÄâ‰∏≠ÂΩìÂâçË°®Ê†º
    table.classList.add('selected');
}

// LLMÊìç‰Ωú
async function llmAction(action) {
    const selectedText = richTextEditor?.selectedText;
    if (!selectedText && !['summarize_all', 'generate_outline'].includes(action)) {
        App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÊñáÊú¨', 'ËØ∑ÈÄâÊã©Ë¶ÅÂ§ÑÁêÜÁöÑÊñáÊú¨ÂÜÖÂÆπ');
        return;
    }
    
    try {
        const response = await fetch('/api/ai/quick-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: action,
                text: selectedText || richTextEditor?.getTextContent(),
                settings: AIAssistant?.settings || {}
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Ê†πÊçÆÊìç‰ΩúÁ±ªÂûãÂ§ÑÁêÜÁªìÊûú
            handleLLMResult(action, data.result, selectedText);
            App.showNotification('success', 'AIÂ§ÑÁêÜÂÆåÊàê', 'ÂÜÖÂÆπÂ∑≤Â§ÑÁêÜÂÆåÊàê');
        } else {
            throw new Error(data.message || 'AIÂ§ÑÁêÜÂ§±Ë¥•');
        }
        
    } catch (error) {
        console.error('LLM Action Error:', error);
        App.showNotification('error', 'AIÂ§ÑÁêÜÂ§±Ë¥•', error.message);
    }
    
    closeLLMPanel();
}

function handleLLMResult(action, result, originalText) {
    switch (action) {
        case 'polish':
        case 'expand':
        case 'summarize':
        case 'translate':
        case 'formal':
        case 'casual':
            // ÊõøÊç¢ÈÄâ‰∏≠ÁöÑÊñáÊú¨
            if (originalText && result) {
                replaceSelectedText(result);
            }
            break;
        case 'explain':
            // Âú®ÈÄâ‰∏≠ÊñáÊú¨ÂêéÊèíÂÖ•Ëß£Èáä
            if (result) {
                insertAfterSelection(` <em>(${result})</em>`);
            }
            break;
        case 'summarize_all':
            // Âú®ÊñáÊ°£ÂºÄÂ§¥ÊèíÂÖ•ÊëòË¶Å
            insertAtBeginning(`<h2>ÊñáÊ°£ÊëòË¶Å</h2><p>${result}</p><hr>`);
            break;
        case 'generate_outline':
            // ÁîüÊàêÂ§ßÁ∫≤
            insertAtBeginning(`<h2>ÊñáÊ°£Â§ßÁ∫≤</h2>${result}<hr>`);
            break;
    }
}

function replaceSelectedText(newText) {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(document.createTextNode(newText));
    }
}

function insertAfterSelection(html) {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.collapse(false); // ÁßªÂä®Âà∞ÈÄâÂå∫Êú´Â∞æ
        
        const div = document.createElement('div');
        div.innerHTML = html;
        const fragment = document.createDocumentFragment();
        while (div.firstChild) {
            fragment.appendChild(div.firstChild);
        }
        range.insertNode(fragment);
    }
}

function insertAtBeginning(html) {
    const editor = document.getElementById('editorDocument');
    if (editor) {
        editor.insertAdjacentHTML('afterbegin', html);
    }
}

async function executeLLMAction() {
    const customInput = document.getElementById('llmCustomInput');
    const instruction = customInput?.value.trim();
    const selectedText = richTextEditor?.selectedText;
    
    if (!selectedText) {
        App.showNotification('warning', 'ËØ∑ÂÖàÈÄâÊã©ÊñáÊú¨', 'ËØ∑ÈÄâÊã©Ë¶ÅÂ§ÑÁêÜÁöÑÊñáÊú¨ÂÜÖÂÆπ');
        return;
    }
    
    if (instruction) {
        try {
            const response = await fetch('/api/ai/quick-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'custom',
                    text: selectedText,
                    instruction: instruction,
                    settings: AIAssistant?.settings || {}
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // ÊõøÊç¢ÈÄâ‰∏≠ÁöÑÊñáÊú¨
                replaceSelectedText(data.result);
                App.showNotification('success', 'AIÂ§ÑÁêÜÂÆåÊàê', 'Ëá™ÂÆö‰πâÊåá‰ª§Â∑≤ÊâßË°åÂÆåÊàê');
                
                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                customInput.value = '';
                closeLLMPanel();
            } else {
                throw new Error(data.message || 'AIÂ§ÑÁêÜÂ§±Ë¥•');
            }
            
        } catch (error) {
            console.error('Custom LLM Action Error:', error);
            App.showNotification('error', 'AIÂ§ÑÁêÜÂ§±Ë¥•', error.message);
        }
    } else {
        App.showNotification('warning', 'ËØ∑ËæìÂÖ•Êåá‰ª§', 'ËØ∑ËæìÂÖ•Ëá™ÂÆö‰πâÂ§ÑÁêÜÊåá‰ª§');
    }
}