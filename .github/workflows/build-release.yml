name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller setuptools
        
    - name: Create assets directory
      run: |
        mkdir -p assets
        echo "Assets directory created"
        
    - name: Build executable
      run: |
        python build.py --mode onefile
        
    - name: Test executable
      run: |
        if (Test-Path "dist/DocumentProcessor.exe") {
          echo "âœ… Executable created successfully"
          $size = (Get-Item "dist/DocumentProcessor.exe").length / 1MB
          echo "ðŸ“Š File size: $([math]::Round($size, 2)) MB"
        } else {
          echo "âŒ Executable not found"
          exit 1
        }
      shell: powershell
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-executable
        path: |
          dist/DocumentProcessor.exe
          release/*.zip
          
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller setuptools
        
    - name: Build executable
      run: |
        # ä¿®æ”¹specæ–‡ä»¶ä»¥é€‚åº”Linux
        sed -i 's/DocumentProcessor/DocumentProcessor-linux/g' build_config.spec
        sed -i '/icon=/d' build_config.spec  # ç§»é™¤Windowså›¾æ ‡
        python -c "
import subprocess
cmd = ['pyinstaller', '--clean', '--noconfirm', '--onefile', 'build_config.spec']
subprocess.run(cmd, check=True)
"
        
    - name: Create Linux package
      run: |
        mkdir -p release
        cd dist
        tar -czf ../release/DocumentProcessor-linux-x64.tar.gz DocumentProcessor-linux
        
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v3
      with:
        name: linux-executable
        path: release/DocumentProcessor-linux-x64.tar.gz
        
  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Windows artifacts
      uses: actions/download-artifact@v3
      with:
        name: windows-executable
        path: artifacts/windows/
        
    - name: Download Linux artifacts
      uses: actions/download-artifact@v3
      with:
        name: linux-executable
        path: artifacts/linux/
        
    - name: Get version from tag or input
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        
    - name: Create release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        # ðŸŽ‰ æ™ºèƒ½æ–‡æ¡£å¤„ç†ç³»ç»Ÿ ${{ steps.get_version.outputs.version }}
        
        ## âœ¨ æ–°åŠŸèƒ½
        - ðŸ¤– **æ™ºèƒ½æ–‡æ¡£æ ¼å¼åŒ–**: æ”¯æŒä¸€å¥è¯å‘½ä»¤è‡ªåŠ¨æŽ’ç‰ˆæ–‡æ¡£
        - ðŸ“„ **å¤šæ ¼å¼è¾“å‡º**: æ”¯æŒHTMLã€PDFã€Wordã€PowerPointã€Markdown
        - ðŸŽ¨ **ä¸“ä¸šæ¨¡æ¿**: å†…ç½®5ç§ä¸“ä¸šæ–‡æ¡£æ¨¡æ¿
        - ðŸ“Š **å†…å®¹åˆ†æž**: è‡ªåŠ¨åˆ†æžæ–‡æ¡£è´¨é‡å¹¶æä¾›ä¼˜åŒ–å»ºè®®
        - ðŸ’¬ **äº¤äº’å¼UI**: æ”¯æŒå®žæ—¶é¢„è§ˆå’Œè¿­ä»£è°ƒæ•´
        
        ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        ### Windowsç”¨æˆ·
        - **DocumentProcessor-v*-win64.zip**: Windows 64ä½å¯æ‰§è¡Œæ–‡ä»¶
        - è§£åŽ‹åŽç›´æŽ¥è¿è¡Œ `DocumentProcessor.exe`
        
        ### Linuxç”¨æˆ·  
        - **DocumentProcessor-linux-x64.tar.gz**: Linux 64ä½å¯æ‰§è¡Œæ–‡ä»¶
        - è§£åŽ‹åŽè¿è¡Œ `./DocumentProcessor-linux`
        
        ## âš™ï¸ ä½¿ç”¨è¦æ±‚
        1. **APIå¯†é’¥**: éœ€è¦è®¾ç½® `OPENAI_API_KEY` çŽ¯å¢ƒå˜é‡
        2. **ç½‘ç»œè¿žæŽ¥**: éœ€è¦è¿žæŽ¥äº’è”ç½‘è°ƒç”¨AIæœåŠ¡
        3. **æ“ä½œç³»ç»Ÿ**: Windows 10+ æˆ– Linux (Ubuntu 18.04+)
        
        ## ðŸš€ å¿«é€Ÿå¼€å§‹
        ```bash
        # è®¾ç½®APIå¯†é’¥ (Windows)
        set OPENAI_API_KEY=your_api_key_here
        
        # è®¾ç½®APIå¯†é’¥ (Linux/Mac)
        export OPENAI_API_KEY=your_api_key_here
        
        # è¿è¡Œç¨‹åº
        ./DocumentProcessor.exe  # Windows
        ./DocumentProcessor-linux  # Linux
        ```
        
        ## ðŸ“– ä½¿ç”¨ç¤ºä¾‹
        - "è½¬æ¢ä¸ºçŽ°ä»£å•†åŠ¡é£Žæ ¼çš„HTMLæ–‡æ¡£ï¼Œå›¾ç‰‡åŠ åœ†è§’è¾¹æ¡†"
        - "ç”Ÿæˆå­¦æœ¯è®ºæ–‡æ ¼å¼çš„PDFï¼Œä½¿ç”¨è“ç™½é…è‰²"
        - "åˆ¶ä½œåˆ›æ„è®¾è®¡æ–‡æ¡£ï¼Œå›¾ç‰‡æ·»åŠ é˜´å½±æ•ˆæžœ"
        
        ## ðŸ› é—®é¢˜åé¦ˆ
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆ
        
        ---
        **æž„å»ºä¿¡æ¯**: 
        - æž„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - Gitæäº¤: ${{ github.sha }}
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: "æ™ºèƒ½æ–‡æ¡£å¤„ç†ç³»ç»Ÿ ${{ steps.get_version.outputs.version }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          artifacts/windows/release/*.zip
          artifacts/linux/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload to Release Assets
      run: |
        echo "ðŸŽ‰ Release created successfully!"
        echo "ðŸ“¦ Assets uploaded:"
        ls -la artifacts/windows/release/ 2>/dev/null || echo "No Windows release files"
        ls -la artifacts/linux/ 2>/dev/null || echo "No Linux release files"