name: Build Enhanced Version

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v2.1.0'

env:
  PYTHON_VERSION: '3.11'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_enhanced.txt
        pip install pyinstaller setuptools wheel
        
    - name: Create assets directory
      run: |
        mkdir assets -Force
        echo "Assets directory created" | Out-File -FilePath assets/readme.txt
        
    - name: Build Enhanced executable using build script
      run: |
        python build_enhanced.py --platform windows --no-test --skip-deps
        
    - name: Test executable
      run: |
        if (Test-Path "dist/DocumentProcessor-Enhanced.exe") {
          echo "âœ… Enhanced executable created successfully"
          $size = (Get-Item "dist/DocumentProcessor-Enhanced.exe").length / 1MB
          echo "ğŸ“Š File size: $([math]::Round($size, 2)) MB"
          # ç®€å•æµ‹è¯•ï¼ˆå¯èƒ½éœ€è¦APIå¯†é’¥ï¼Œæ‰€ä»¥åªæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼‰
          echo "âœ… Executable test completed"
        } else {
          echo "âŒ Executable not found"
          Get-ChildItem dist -Recurse
          exit 1
        }
      shell: powershell
      
    - name: Verify package creation
      run: |
        if (Test-Path "release/*.zip") {
          $packages = Get-ChildItem "release/*.zip"
          foreach ($package in $packages) {
            echo "âœ… Package created: $($package.Name)"
            echo "ğŸ“Š Package size: $([math]::Round($package.Length / 1MB, 2)) MB"
          }
        } else {
          echo "âŒ No packages found"
          Get-ChildItem release -Recurse -ErrorAction SilentlyContinue
          exit 1
        }
      shell: powershell
      
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-enhanced
        path: |
          dist/DocumentProcessor-Enhanced.exe
          release/*win64*.zip
          
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_enhanced.txt
        pip install pyinstaller setuptools wheel
        
    - name: Build Enhanced Linux executable
      run: |
        python build_enhanced.py --platform linux --no-test --skip-deps
        
    - name: Test Linux executable
      run: |
        if [ -f "dist/DocumentProcessor-Enhanced-linux" ]; then
          echo "âœ… Enhanced Linux executable created successfully"
          size=$(du -h "dist/DocumentProcessor-Enhanced-linux" | cut -f1)
          echo "ğŸ“Š File size: $size"
          chmod +x "dist/DocumentProcessor-Enhanced-linux"
          echo "âœ… Executable test completed"
        else
          echo "âŒ Executable not found"
          ls -la dist/
          exit 1
        fi
        
    - name: Verify Linux package creation
      run: |
        if ls release/*linux-x64*.tar.gz 1> /dev/null 2>&1; then
          for package in release/*linux-x64*.tar.gz; do
            echo "âœ… Package created: $(basename $package)"
            size=$(du -h "$package" | cut -f1)
            echo "ğŸ“Š Package size: $size"
          done
        else
          echo "âŒ No Linux packages found"
          ls -la release/ || echo "Release directory not found"
          exit 1
        fi
        
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v3
      with:
        name: linux-enhanced
        path: |
          dist/DocumentProcessor-Enhanced-linux
          release/*linux-x64*.tar.gz
          
  create-enhanced-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Windows artifacts
      uses: actions/download-artifact@v3
      with:
        name: windows-enhanced
        path: artifacts/windows/
        
    - name: Download Linux artifacts
      uses: actions/download-artifact@v3
      with:
        name: linux-enhanced
        path: artifacts/linux/
        
    - name: Get version from tag or input
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        
    - name: Load version info
      id: version_info
      run: |
        if [ -f "version.json" ]; then
          VERSION_NUM=$(cat version.json | jq -r '.version')
          BUILD_NUM=$(cat version.json | jq -r '.build_number')
          DESCRIPTION=$(cat version.json | jq -r '.description')
          echo "version_num=${VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "build_num=${BUILD_NUM}" >> $GITHUB_OUTPUT
          echo "description=${DESCRIPTION}" >> $GITHUB_OUTPUT
        else
          echo "version_num=2.1.0" >> $GITHUB_OUTPUT
          echo "build_num=3" >> $GITHUB_OUTPUT
          echo "description=æ™ºèƒ½æ–‡æ¡£è‡ªåŠ¨æ’ç‰ˆç³»ç»Ÿ - å¢å¼ºç‰ˆ" >> $GITHUB_OUTPUT
        fi
        
    - name: Create enhanced release notes
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        # ğŸ‰ æ™ºèƒ½æ–‡æ¡£å¤„ç†ç³»ç»Ÿ ${{ steps.get_version.outputs.version }} - å¢å¼ºç‰ˆ
        
        > ${{ steps.version_info.outputs.description }}
        
        ## ğŸš€ é‡å¤§æ›´æ–°
        
        ### âœ¨ å¢å¼ºç‰ˆç‰¹æ€§
        - **ğŸ¯ ç»Ÿä¸€å…¥å£ç¨‹åº**: main_enhanced.py æä¾›4ç§è¿è¡Œæ¨¡å¼
        - **ğŸ” ç¯å¢ƒè‡ªæ£€**: è‡ªåŠ¨æ£€æµ‹Pythonç‰ˆæœ¬ã€ä¾èµ–ã€APIå¯†é’¥çŠ¶æ€
        - **ğŸ“ è¯¦ç»†æ—¥å¿—**: ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼Œæ”¯æŒæ–‡ä»¶å’Œæ§åˆ¶å°è¾“å‡º
        - **ğŸ”§ å¤šå¹³å°æ„å»º**: Windowså’ŒLinuxåŒå¹³å°è‡ªåŠ¨åŒ–æ„å»º
        - **ğŸ“¦ æ™ºèƒ½æ‰“åŒ…**: è‡ªåŠ¨åˆ›å»ºå¯åŠ¨è„šæœ¬å’Œä½¿ç”¨è¯´æ˜
        
        ### ğŸ¨ ç”¨æˆ·ä½“éªŒæå‡
        - **å¤šç§å¯åŠ¨æ–¹å¼**: WebæœåŠ¡ã€å‘½ä»¤è¡Œã€ç³»ç»Ÿä¿¡æ¯ã€APIæµ‹è¯•
        - **å‹å¥½é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸æ•è·å’Œç”¨æˆ·æç¤º
        - **å®æ—¶è¿›åº¦æ˜¾ç¤º**: Webç•Œé¢å®æ—¶æ›´æ–°å¤„ç†çŠ¶æ€
        - **æ‰¹é‡å¤„ç†æ”¯æŒ**: é«˜æ•ˆå¤„ç†å¤šä¸ªæ–‡æ¡£
        
        ### ğŸ”§ æŠ€æœ¯æ”¹è¿›
        - **å¼‚æ­¥é«˜æ€§èƒ½å¤„ç†**: 3-5å€é€Ÿåº¦æå‡
        - **å†…å­˜ä¼˜åŒ–**: 30-50%å†…å­˜ä½¿ç”¨é‡å‡å°‘
        - **ä¾èµ–ç®¡ç†ä¼˜åŒ–**: å®Œæ•´çš„ç‰ˆæœ¬æ§åˆ¶å’Œå…¼å®¹æ€§
        - **è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹**: ä»æ„å»ºåˆ°å‘å¸ƒçš„å…¨æµç¨‹è‡ªåŠ¨åŒ–
        
        ## ğŸ“¦ ä¸‹è½½è¯´æ˜
        
        ### Windows ç”¨æˆ·
        - **DocumentProcessor-Enhanced-v${{ steps.version_info.outputs.version }}-win64.zip**: Windows 64ä½å¢å¼ºç‰ˆ
        - è§£å‹ååŒå‡»è¿è¡Œ \`å¯åŠ¨.bat\` é€‰æ‹©è¿è¡Œæ¨¡å¼
        - æˆ–ç›´æ¥è¿è¡Œ \`DocumentProcessor-Enhanced.exe --web\`
        
        ### Linux ç”¨æˆ·  
        - **DocumentProcessor-Enhanced-v${{ steps.version_info.outputs.version }}-linux-x64.tar.gz**: Linux 64ä½å¢å¼ºç‰ˆ
        - è§£å‹åè¿è¡Œ \`./start.sh\` é€‰æ‹©è¿è¡Œæ¨¡å¼
        - æˆ–ç›´æ¥è¿è¡Œ \`./DocumentProcessor-Enhanced --web\`
        
        ## âš™ï¸ ç³»ç»Ÿè¦æ±‚
        1. **APIå¯†é’¥**: éœ€è¦è®¾ç½® \`OPENAI_API_KEY\` ç¯å¢ƒå˜é‡
        2. **ç½‘ç»œè¿æ¥**: éœ€è¦è¿æ¥äº’è”ç½‘è°ƒç”¨AIæœåŠ¡
        3. **æ“ä½œç³»ç»Ÿ**: Windows 10+ æˆ– Linux (Ubuntu 18.04+)
        4. **å†…å­˜**: å»ºè®®2GBä»¥ä¸Šå¯ç”¨å†…å­˜
        
        ## ğŸš€ å¿«é€Ÿå¼€å§‹
        
        ### WebæœåŠ¡æ¨¡å¼ (æ¨è)
        \`\`\`bash
        # è®¾ç½®APIå¯†é’¥
        export OPENAI_API_KEY=your_api_key_here
        
        # å¯åŠ¨WebæœåŠ¡
        ./DocumentProcessor-Enhanced --web
        
        # è®¿é—® http://localhost:8000
        \`\`\`
        
        ### å‘½ä»¤è¡Œæ¨¡å¼
        \`\`\`bash
        # äº¤äº’å¼å¤„ç†
        ./DocumentProcessor-Enhanced --cli
        
        # æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
        ./DocumentProcessor-Enhanced --info
        
        # æµ‹è¯•APIè¿æ¥
        ./DocumentProcessor-Enhanced --test
        \`\`\`
        
        ## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§
        
        - âœ¨ å¢å¼ºç‰ˆä¸»ç¨‹åºï¼šç»Ÿä¸€å…¥å£ï¼Œå¤šç§è¿è¡Œæ¨¡å¼
        - ğŸ” ç¯å¢ƒæ£€æµ‹å’Œä¾èµ–ç®¡ç†
        - ğŸ“ è¯¦ç»†æ—¥å¿—è®°å½•å’Œé”™è¯¯å¤„ç†
        - ğŸ”§ å¤šå¹³å°è‡ªåŠ¨åŒ–æ„å»ºç³»ç»Ÿ
        - ğŸ“¦ è‡ªåŠ¨åŒ–ç‰ˆæœ¬ç®¡ç†å’Œå‘å¸ƒ
        - ğŸ“š å®Œæ•´çš„æ–‡æ¡£å’ŒæŒ‡å—ç³»ç»Ÿ
        - ğŸŒ ç°ä»£åŒ–Webç•Œé¢å’Œå®æ—¶é€šä¿¡
        - âš¡ å¼‚æ­¥é«˜æ€§èƒ½å¤„ç† (3-5å€é€Ÿåº¦æå‡)
        - ğŸ¤– æ™ºèƒ½AIå†³ç­–å’Œè‡ªé€‚åº”ç­–ç•¥
        - ğŸ“Š è´¨é‡åˆ†æå’Œç›‘æ§
        - ğŸ¯ æ™ºèƒ½ä»£ç†ç³»ç»Ÿ
        
        ## ğŸ’¡ ä½¿ç”¨æŠ€å·§
        1. **æ˜ç¡®æè¿°éœ€æ±‚**: è¶Šå…·ä½“çš„æè¿°ï¼ŒAIç†è§£å¾—è¶Šå‡†ç¡®
        2. **åˆ©ç”¨Webç•Œé¢**: Webæ¨¡å¼æä¾›æœ€ä½³ç”¨æˆ·ä½“éªŒ  
        3. **æ‰¹é‡å¤„ç†ä¼˜åŒ–**: å¤„ç†å¤šä¸ªç›¸ä¼¼æ–‡æ¡£æ—¶ä½¿ç”¨æ‰¹é‡æ¨¡å¼
        4. **ç¯å¢ƒæ£€æµ‹**: ä½¿ç”¨ \`--info\` å‚æ•°æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        5. **APIæµ‹è¯•**: ä½¿ç”¨ \`--test\` å‚æ•°éªŒè¯APIè¿æ¥
        
        ## ğŸ”— ç›¸å…³é“¾æ¥
        - **é¡¹ç›®ä¸»é¡µ**: https://github.com/5-56/PocketFlow
        - **ä½¿ç”¨æ–‡æ¡£**: https://github.com/5-56/PocketFlow/blob/main/README.md
        - **æ„å»ºæŒ‡å—**: https://github.com/5-56/PocketFlow/blob/main/BUILD_GUIDE.md
        - **é—®é¢˜åé¦ˆ**: https://github.com/5-56/PocketFlow/issues
        
        ---
        **æ„å»ºæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')  
        **ç‰ˆæœ¬**: ${{ steps.version_info.outputs.version }}  
        **æ„å»ºå·**: ${{ steps.version_info.outputs.build_num }}  
        **å¹³å°**: Windows x64, Linux x64
        EOF
        
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: List all artifacts
      run: |
        echo "ğŸ“¦ æ„å»ºäº§ç‰©åˆ—è¡¨:"
        find artifacts -type f -name "*.exe" -o -name "*.zip" -o -name "*.tar.gz" | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "  ğŸ“„ $(basename "$file") - $size"
        done
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: "æ™ºèƒ½æ–‡æ¡£å¤„ç†ç³»ç»Ÿ ${{ steps.get_version.outputs.version }} - å¢å¼ºç‰ˆ"
        body: ${{ steps.release_notes.outputs.release_notes }}
        draft: false
        prerelease: false
        files: |
          artifacts/windows/*.exe
          artifacts/windows/*.zip
          artifacts/linux/DocumentProcessor-Enhanced-linux
          artifacts/linux/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}